import{_ as S,B as k,d as L,a2 as O,r,q as c,k as m,w as t,o as e,n as g,s as u,u as f,p as I,ai as P,m as b,ah as E,a1 as B,f as z,x as R,I as N,an as _,aw as F,b2 as U,aR as W,fr as H,dS as X,F as x,t as D}from"./index-13ff96f4.js";import{u as j}from"./useTableSorting-22e45d25.js";import{D as q,a as Y}from"./DataTable-e31a825a.js";import{u as T}from"./useInstanceGroupScanningProgress-7091a8e2.js";import{a as J,b as K}from"./dateFns-a344cb79.js";import{D as M,a as V}from"./DataTableCell-51c0104f.js";import{C as Q,s as Z}from"./scanningLimits-8d03a4e6.js";import{D as $}from"./DataTableSeverityIndicator-48ffb8dc.js";import{C as ee}from"./ContainersIllustration-8126771c.js";import{O as ne}from"./OverviewEmptyState-c8440b9c.js";import{I as te}from"./InputFilterDropdown-674351d9.js";import"./tableSortingCache-ca369cac.js";import"./index-b87db690.js";import"./ActionMenu-3e4470bf.js";import"./FilterButton-bb5393a7.js";const ae={props:{instanceGroup:Object},components:{BaseParagraph:k,BasePill:L,CloudInstanceGroupActionMenu:Q,DataTableCell:M,DataTableRow:V,DataTableSeverityIndicator:$,XTooltip:O},setup(){const{registerInstanceGroup:n,scanningProgress:a}=T();return{registerInstanceGroup:n,scanningProgress:a}},mounted(){this.registerInstanceGroup(this.instanceGroup.external_id)},computed:{href(){return this.instanceGroupIsDisabled?null:`/clouds/${this.instanceGroup.cloud_id}/virtual-machines/${this.instanceGroup.id}`},isScanning(){var n;return!this.scanningProgress||!this.instanceGroup.active?!1:((n=this.scanningProgress)==null?void 0:n.status)==="scanning"},scanningProgressValue(){var n;return(n=this.scanningProgress)==null?void 0:n.progress},scanningProgressMessage(){var n,a;return(n=this.scanningProgress)!=null&&n.progressMessageCode?this.$t(`VIRTUAL_MACHINES_SCANNING_PROGRESS_MESSAGE_${(a=this.scanningProgress)==null?void 0:a.progressMessageCode}`):null},isScanned(){return this.instanceGroup.last_scanned_at>0},formattedTimestamp(){return this.isScanned?J(this.instanceGroup.last_scanned_at):"No scan yet"},formattedTimestampForMobile(){return this.isScanned?this.$t("REPO_OVERVIEW.LAST_ACTIVITY",{time:K(this.instanceGroup.last_scanned_at)}):"No scan yet"},instanceGroupIsDisabled(){return!this.instanceGroup.active},environment(){return this.instanceGroup.cloud_purpose!="mixed"?null:this.instanceGroup.environment},hardDriveSizeGb(){const n=this.instanceGroup.hard_drive_size_in_gb;if(!n)return null;const a=parseInt(n,10);return isNaN(a)?null:a},hardDriveSizeLimitGb(){var n;return((n=Z[this.instanceGroup.cloud_kind])==null?void 0:n.maxHardDriveSizeGb)??0},isUnscannableDueToHardDriveSize(){return this.instanceGroup.cloud_kind!=="azure"||!this.hardDriveSizeGb?!1:this.hardDriveSizeGb>this.hardDriveSizeLimitGb}},methods:{handleOpenEditInstanceGroupPurposeModal(){this.$modal.show("EditCloudInstanceGroupPurposeModal",{cloudId:this.instanceGroup.cloud_id,instanceGroup:this.instanceGroup})}}},se={class:"flex flex-column gap-8px justify-between flex-1"},ie={class:"flex align-center gap-4px"},oe=g("div",{class:"shimmer shimmer--blue"},null,-1),re=[oe],le=g("i",{class:"icon icon-information icon-12px leading-14px"},null,-1),ce={class:"hidden sm:block"},ue={class:"block sm:hidden"};function de(n,a,i,G,d,s){const o=r("BaseParagraph"),l=r("BasePill"),p=r("DataTableCell"),h=r("DataTableSeverityIndicator"),y=r("XTooltip"),w=r("CloudInstanceGroupActionMenu"),C=r("DataTableRow");return c(),m(C,{clickable:"",href:s.href,disabled:s.instanceGroupIsDisabled},{default:t(()=>[e(p,null,{default:t(()=>[g("div",se,[e(o,null,{default:t(()=>[u(f(i.instanceGroup.name),1)]),_:1}),g("div",ie,[s.scanningProgressMessage?(c(),m(l,{key:0,variation:"gray-fill",title:s.scanningProgressMessage},null,8,["title"])):I("",!0),e(l,{variation:"gray-fill",title:i.instanceGroup.region},null,8,["title"]),e(l,{variation:"gray-fill",class:"wide-tablet_hidden",title:n.$t("X_VM_INSTANCES",i.instanceGroup.instance_count)},null,8,["title"]),s.environment?(c(),m(l,{key:1,variation:"gray-fill",title:s.environment},null,8,["title"])):I("",!0)])])]),_:1}),e(p,null,{default:t(()=>[e(o,{class:"text-break-all"},{default:t(()=>[u(f(i.instanceGroup.cloud_name),1)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(o,null,{default:t(()=>[u(f(i.instanceGroup.count_open_issues),1)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(o,null,{default:t(()=>[u(f(i.instanceGroup.count_ignored_issues),1)]),_:1})]),_:1}),e(h,{priority:i.instanceGroup.max_issue_severity},null,8,["priority"]),e(p,{class:"desktop-medium_data-table__column__folded"},{default:t(()=>[i.instanceGroup.purpose?(c(),m(o,{key:0},{default:t(()=>[u(f(i.instanceGroup.purpose),1)]),_:1})):(c(),m(l,{key:1,class:"cursor-pointer",icon:"icon-settings",title:"Configure",variation:"gray-fill",onClick:P(s.handleOpenEditInstanceGroupPurposeModal,["prevent"])},null,8,["onClick"]))]),_:1}),e(p,null,{default:t(()=>[s.isScanning?(c(),b("div",{key:0,class:"loading-bar",style:E({width:`${s.scanningProgressValue}%`})},re,4)):i.instanceGroup.active&&s.isUnscannableDueToHardDriveSize?(c(),m(o,{key:1,class:"inline-flex align-center gap-2px"},{default:t(()=>[u(" No scan "),le,e(y,null,{default:t(()=>[u("We are unable to scan this hard drive because it's size of "+f(s.hardDriveSizeGb)+"GB exceeds the limit of "+f(s.hardDriveSizeLimitGb)+"GB",1)]),_:1})]),_:1})):i.instanceGroup.active?(c(),m(o,{key:2,class:"truncate"},{default:t(()=>[g("span",ce,f(s.formattedTimestamp),1),g("span",ue,f(s.formattedTimestampForMobile),1)]),_:1})):I("",!0)]),_:1}),e(w,{"instance-group":i.instanceGroup,"cloud-id":i.instanceGroup.cloud_id},null,8,["instance-group","cloud-id"])]),_:1},8,["href","disabled"])}const pe=S(ae,[["render",de]]),he={components:{DataTableCell:M,DataTableRow:V,LoadingSkeleton:B}},_e={class:"w-full flex flex-column gap-8px"},me={class:"w-200px flex gap-4px"};function ge(n,a,i,G,d,s){const o=r("LoadingSkeleton"),l=r("DataTableCell"),p=r("DataTableRow");return c(),m(p,null,{default:t(()=>[e(l,null,{default:t(()=>[g("div",_e,[e(o,{height:"16px"}),g("div",me,[e(o,{height:"16px"}),e(o,{height:"16px"})])])]),_:1}),e(l,null,{default:t(()=>[e(o,{height:"16px"})]),_:1}),e(l,null,{default:t(()=>[e(o,{height:"16px"})]),_:1}),e(l,null,{default:t(()=>[e(o,{height:"16px"})]),_:1}),e(l,null,{default:t(()=>[e(o,{height:"16px"})]),_:1}),e(l,null,{default:t(()=>[e(o,{height:"16px"})]),_:1}),e(l,null,{default:t(()=>[e(o,{height:"16px"})]),_:1})]),_:1})}const fe=S(he,[["render",ge]]),ve={props:{clouds:Array},components:{OverviewEmptyState:ne,ContainersIllustration:ee},computed:{actionLabel(){return this.eligibleClouds.length==0?null:"Set Up VM scanning"},eligibleClouds(){const n=["aws","azure"];return this.clouds.filter(a=>n.includes(a.type))}},methods:{handleAction(){if(this.eligibleClouds.length===1){const n=this.eligibleClouds[0].id;return this.$router.push(`/side-scanning/${n}/connect/aws`)}this.$modal.show("ConnectVirtualMachinesModal",{clouds:this.clouds})}}};function Ge(n,a,i,G,d,s){const o=r("ContainersIllustration"),l=r("OverviewEmptyState");return c(),m(l,{title:"No virtual machines found",description:"Aikido can scan your VM instances for open-source dependencies, EOL runtimes and licences.",variation:"empty",actionLabel:"Set Up VM scanning",onOnAction:s.handleAction},{default:t(()=>[e(o)]),_:1},8,["onOnAction"])}const be=S(ve,[["render",Ge]]),Ie={components:{BaseButton:z,BaseIcon:R,DataTable:q,DataTableHeader:Y,InputFilterDropdown:te,InputSearch:N,VirtualMachineOverviewRow:pe,VirtualMachineOverviewRowLoading:fe,VirtualMachineOverviewEmptyState:be},data(){return{hasEnabledSideScanning:!0,isLoading:!0,instanceGroups:[],clouds:[],cloudsWithInstances:[],selectedFilterCloudId:"",searchTerm:""}},setup(){const{sorting:n,handleChangeSorting:a}=j(),{addListener:i,removeListener:G}=T();return{sorting:n,handleChangeSorting:a,addInstanceGroupScanningListener:i,removeInstanceGroupScanningListener:G}},created(){_.on("side-scanning-instance-group-created",this.getAllInstanceGroupsDebounced),this.addInstanceGroupScanningListener(),_.on("side-scanning-instance-group-deactivated",this.reloadInstanceGroups),_.on("side-scanning-instance-group-activated",this.reloadInstanceGroups),_.on("instanceGroupPurposeUpdated",this.getAllInstanceGroups),_.on("virtualMachineScanCompleted",this.getAllInstanceGroups)},beforeUnmount(){_.off("side-scanning-instance-group-created",this.getAllInstanceGroupsDebounced),this.removeInstanceGroupScanningListener(),_.off("side-scanning-instance-group-deactivated",this.reloadInstanceGroups),_.off("side-scanning-instance-group-activated",this.reloadInstanceGroups),_.off("instanceGroupPurposeUpdated",this.getAllInstanceGroups),_.off("virtualMachineScanCompleted",this.getAllInstanceGroups)},async mounted(){try{await Promise.allSettled([this.getAllInstanceGroups(),this.getAllClouds(),this.getCloudsWithCloudInstances()])}finally{this.isLoading=!1}},watch:{async sorting(){this.reloadInstanceGroups()}},computed:{showEmptyState(){return!this.isLoading&&this.hasEnabledSideScanning&&this.instanceGroups.length===0},availableCloudFilterOptions(){const n=this.cloudsWithInstances.map(a=>({value:a.id,label:a.name}));return[{value:"",label:"All Clouds",default:!0},...n]}},methods:{getAllInstanceGroupsDebounced:F(async function(){this.getAllInstanceGroups()},500),async getAllInstanceGroups(){var n,a;this.instanceGroups=await U({filter_cloud_id:this.selectedFilterCloudId,filter_search_term:this.searchTerm,sort_by_column:(n=this.sorting)==null?void 0:n.column,sort_by_direction:(a=this.sorting)==null?void 0:a.direction})},async getAllClouds(){this.clouds=await W()},async getCloudsWithCloudInstances(){this.cloudsWithInstances=await H()},async handleScanVirtualMachines(){const n=this.instanceGroups.map(i=>i.cloud_id),a=Array.from(new Set(n));for(const i of a)await X(i)},async reloadInstanceGroups(){this.$globalLoadingIndicator.show();try{await this.getAllInstanceGroups()}finally{this.$globalLoadingIndicator.hide()}}}},Se={class:"flex flex-1 gap-8px mb-16px"},ye={class:"ml-auto"},we={key:1,colspan:"7"};function Ce(n,a,i,G,d,s){const o=r("InputSearch"),l=r("InputFilterDropdown"),p=r("BaseButton"),h=r("DataTableHeader"),y=r("VirtualMachineOverviewRow"),w=r("VirtualMachineOverviewRowLoading"),C=r("VirtualMachineOverviewEmptyState"),A=r("DataTable");return c(),b(x,null,[g("div",Se,[e(o,{modelValue:d.searchTerm,"onUpdate:modelValue":[a[0]||(a[0]=v=>d.searchTerm=v),s.reloadInstanceGroups],spacing:"compact"},null,8,["modelValue","onUpdate:modelValue"]),e(l,{options:s.availableCloudFilterOptions,modelValue:d.selectedFilterCloudId,"onUpdate:modelValue":[a[1]||(a[1]=v=>d.selectedFilterCloudId=v),s.reloadInstanceGroups]},null,8,["options","modelValue","onUpdate:modelValue"]),g("div",ye,[e(p,{size:"small",variation:"primary",onClick:s.handleScanVirtualMachines},{default:t(()=>[u(" Scan VMs ")]),_:1},8,["onClick"])])]),e(A,null,{header:t(()=>[e(h,{width:"auto"},{default:t(()=>[u("Name")]),_:1}),e(h,{width:"150px"},{default:t(()=>[u("Cloud")]),_:1}),e(h,{width:"85px"},{default:t(()=>[u("# Open")]),_:1}),e(h,{width:"100px"},{default:t(()=>[u("# Ignored")]),_:1}),e(h,{width:"113px",alignment:"center","sort-by":"max_issue_severity",sorted:G.sorting.column==="max_issue_severity",onSort:G.handleChangeSorting,"inverted-sorting":""},{default:t(()=>[u("Severity")]),_:1},8,["sorted","onSort"]),e(h,{class:"desktop-medium_data-table__column__folded",width:"250px"},{default:t(()=>[u("Purpose")]),_:1}),e(h,{width:"115px"},{default:t(()=>[u("Last scan")]),_:1}),e(h,{width:"48px",alignment:"center"})]),body:t(()=>[(c(!0),b(x,null,D(d.instanceGroups,v=>(c(),m(y,{key:v.id,"instance-group":v},null,8,["instance-group"]))),128)),d.isLoading?(c(),b(x,{key:0},D(5,v=>e(w,{key:v})),64)):I("",!0),s.showEmptyState?(c(),b("td",we,[e(C,{clouds:d.clouds},null,8,["clouds"])])):I("",!0)]),_:1})],64)}const Fe=S(Ie,[["render",Ce]]);export{Fe as default};
