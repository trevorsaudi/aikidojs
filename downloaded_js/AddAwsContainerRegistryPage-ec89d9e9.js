import{_ as b,bk as R,g as A,f as x,H as B,B as C,x as S,a2 as P,a as m,A as g,bl as T,r as s,q as v,m as I,o as t,w as o,s as e,n as a,V as U,N as V,bm as E,F as L}from"./index-13ff96f4.js";import{P as z}from"./PageHeader-46c38a32.js";import{U as W}from"./UploadJsonFileInput-be53818c.js";import{_ as $}from"./awsoutputtab-d18f8503.js";const N={props:{},emits:["cancel","continue"],components:{BaseBody:R,BaseLink:A,BaseButton:x,BaseHeading:B,BaseParagraph:C,BaseIcon:S,XTooltip:P},computed:{templateUrl(){return m()==="staging"?"https://aikido-staging-staticfiles-public.s3.eu-west-1.amazonaws.com/minimal-policy-ecr-access.json	":m()==="production"?"https://aikido-production-staticfiles-public.s3.eu-west-1.amazonaws.com/minimal-policy-ecr-access.json	":"https://aikido-dev-staticfiles-public.s3.eu-west-1.amazonaws.com/minimal-policy-ecr-access.json	"}},methods:{handleCancel(){this.$emit("cancel")},handleSubmit(){this.$emit("continue")},handleInstallIamRoleAndPolicy(){let n=`https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?stackName=aikido-security-ecr-readonly-dev&templateURL=https://aikido-dev-staticfiles-public.s3.eu-west-1.amazonaws.com/minimal-policy-ecr-access.json&param_ExternalId=aikido-${g.data.groupId}`;m()==="staging"?n=`https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?stackName=aikido-security-ecr-readonly-staging&templateURL=https://aikido-staging-staticfiles-public.s3.eu-west-1.amazonaws.com/minimal-policy-ecr-access.json&param_ExternalId=aikido-${g.data.groupId}`:m()==="production"&&(n=`https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?stackName=aikido-security-ecr-readonly&templateURL=https://aikido-production-staticfiles-public.s3.eu-west-1.amazonaws.com/minimal-policy-ecr-access.json&param_ExternalId=aikido-${g.data.groupId}`),window.open(n,"_blank")},async handleDownloadTerraformTemplate(){await T().then(n=>{const r=window.URL.createObjectURL(new Blob([n.file_content])),c=document.createElement("a");c.href=r,c.setAttribute("download","aikido_aws-ecr_terraform.tf"),document.body.appendChild(c),c.click()})}}},j={class:"flex flex-column gap-12px"},D={class:"ul text-carbon-80"},F=a("strong",null,"«I acknowledge that AWS CloudFormation might create IAM resources»",-1),H=a("strong",null,"create stack",-1),M={class:"inline-flex gap-4px align-center"},K=a("strong",null,"outputs",-1),X=a("img",{src:$,class:"rounded-2px",width:"800"},null,-1),q=a("strong",null,"AikidoRoleARN",-1);function Y(n,r,c,w,d,l){const i=s("BaseParagraph"),u=s("BaseLink"),p=s("XTooltip"),h=s("BaseIcon"),_=s("BaseButton");return v(),I("div",j,[t(i,null,{default:o(()=>[e(" Please go to your AWS account and login. You’ll need to complete the next few steps in the AWS UI. ")]),_:1}),a("div",null,[a("ul",D,[a("li",null,[t(i,null,{default:o(()=>[e("Log into your "),t(u,{href:"https://console.aws.amazon.com/",target:"_blank"},{default:o(()=>[e("AWS account")]),_:1}),e(".")]),_:1})]),a("li",null,[t(i,null,{default:o(()=>[e("Use the below button to create the required IAM Role & Policy using Cloudformation template.")]),_:1})]),a("li",null,[t(i,null,{default:o(()=>[e("You’ll also need to mark "),F]),_:1})]),a("li",null,[t(i,null,{default:o(()=>[e("Then click "),H]),_:1})]),a("li",null,[t(i,null,{default:o(()=>[e("In AWS Cloudformation, click the stack that was just created.")]),_:1})]),a("li",null,[t(i,null,{default:o(()=>[a("span",M,[e(" Navigate to the "),K,e(" tab. "),t(h,{icon:"icon-help",class:"cursor-help inline-flex"},{default:o(()=>[t(p,{noOpacity:""},{default:o(()=>[X]),_:1})]),_:1})])]),_:1})]),a("li",null,[t(i,null,{default:o(()=>[e("Copy the "),q,e(" and paste it below")]),_:1})])])]),t(i,{loose:!0},{default:o(()=>[e(" Via this IAM role, Aikido will be able to have read access to ECR resources in your AWS account. Want to know what kind of permissions you'll be giving Aikido? "),t(u,{href:l.templateUrl,target:"_blank"},{default:o(()=>[e("Click here")]),_:1},8,["href"]),e(" to see the policy. Alternatively, you can download the Terraform code to create the role "),t(u,{as:"button",onClick:l.handleDownloadTerraformTemplate},{default:o(()=>[e("here")]),_:1},8,["onClick"]),e(". ")]),_:1}),t(_,{variation:"blue",size:"small",onClicked:l.handleInstallIamRoleAndPolicy},{default:o(()=>[e("Create IAM Role & Policy")]),_:1},8,["onClicked"])])}const O=b(N,[["render",Y]]),Z={components:{PageHeader:z,BaseHeading:B,BaseLink:A,InputText:U,BaseButton:x,BaseParagraph:C,BaseSelect:V,UploadJsonFileInput:W,CreateAwsRole:O},data(){return{name:"",roleArn:"",isSaving:!1}},computed:{isFormValid(){return!(this.name.trim()===""||this.roleArn.trim()==="")},isSubmitButtonDisabled(){return!this.isFormValid},docsUrl(){return"https://help.aikido.dev/en/articles/8911170-container-scanning-for-aws-ecr-with-the-aikido-scanner"}},methods:{handleCancel(){this.$router.back()},handleKeyDown(){this.isFormValid&&this.handleSubmit()},async handleSubmit(){this.isSaving=!0;const n=await this.createRegistry();if(n.status==="success")return n;const{cloud_id:r,account_id:c}=n;(await this.$modal.show("DisableAwsContainerAnalysisModal",{cloudId:r,accountId:c})).type==="saved"&&await this.createRegistry()},async createRegistry(){this.isSaving=!0;try{const n=await E({name:this.name,roleArn:this.roleArn});return n.status!=="success"||(Toast.success({title:"Container registry connected",description:"We will scan this registry and show the repositories we found on the settings page"}),this.$router.push("/settings/container-image-registry")),n}finally{this.isSaving=!1}}}},J={class:"page-content bg-white"},G={class:"flex flex-column gap-32px"},Q={class:"flex flex-column gap-8px"},ee={class:"flex flex-column gap-32px"},te={class:"flex flex-column gap-24px"},ae=a("hr",{class:"divider my-24px"},null,-1),oe={class:"flex flex-end gap-16px mt-12px justify-end"};function ne(n,r,c,w,d,l){const i=s("PageHeader"),u=s("BaseHeading"),p=s("BaseLink"),h=s("BaseParagraph"),_=s("CreateAwsRole"),k=s("InputText"),y=s("BaseButton");return v(),I(L,null,[t(i,{breadcrumbs:n.breadcrumbs,title:"Container image registry connection"},null,8,["breadcrumbs"]),a("div",J,[a("div",G,[a("div",Q,[t(u,{as:"h3"},{default:o(()=>[e("Connect AWS Elastic Container Registry service")]),_:1}),t(h,{size:"medium",loose:""},{default:o(()=>[e(" Read our documentation on "),t(p,{href:l.docsUrl,target:"_blank"},{default:o(()=>[e("How to connect your AWS ECR")]),_:1},8,["href"]),e(". ")]),_:1})]),a("div",ee,[t(_),a("div",te,[t(k,{title:"Registry name",placeholder:"PiedPiper containers",modelValue:d.name,"onUpdate:modelValue":r[0]||(r[0]=f=>d.name=f),modelModifiers:{trim:!0},name:"name",onEnterKeyPress:l.handleKeyDown,required:!0},null,8,["modelValue","onEnterKeyPress"]),t(k,{title:"AWS Role ARN",placeholder:"arn:aws:iam::123830977344:role/aikido-security-ecr-readonly-AikidoSecurityRole-XYZXYZ123456",modelValue:d.roleArn,"onUpdate:modelValue":r[1]||(r[1]=f=>d.roleArn=f),modelModifiers:{trim:!0},name:"role_arn",onEnterKeyPress:l.handleKeyDown,required:!0},null,8,["modelValue","onEnterKeyPress"])])])]),a("div",null,[ae,a("div",oe,[t(y,{variation:"plain",onClicked:l.handleCancel},{default:o(()=>[e("Cancel")]),_:1},8,["onClicked"]),t(y,{disabled:l.isSubmitButtonDisabled,onClicked:l.handleSubmit,isLoading:d.isSaving},{default:o(()=>[e("Save")]),_:1},8,["disabled","onClicked","isLoading"])])])])],64)}const ce=b(Z,[["render",ne]]);export{ce as default};
