import{A as k,_ as V,M as F,f as z,B as P,H as q,N as H,V as j,a2 as X,X as G,fz as Y,ad as W,fA as Q,fB as J,fC as K,fD as x,O as w,fE as Z,fF as $,fG as ee,r as d,q as a,k as m,w as o,n as s,s as r,u as S,p as u,o as l,ai as te,m as y,F as b,t as ie,U as ne,aQ as se}from"./index-13ff96f4.js";import{B as oe}from"./BaseRadioInput-a7ac3557.js";import{B as ae}from"./BaseForm-4c6fa06f.js";import{S as re,N as le,A as ce}from"./AktoOpenapiSpecSelector-7b7ef30c.js";import{B as de}from"./ButtonMultiOption-12e505fb.js";import{S as ue}from"./SelectTeam-d51b76ec.js";import"./repoName-872812ed.js";import"./InputMultiSelect-21584437.js";import"./ActionMenu-3e4470bf.js";import"./InputCheckbox-81cb3ca6.js";import"./StackedAvatars-4925baeb.js";const he={extreme:"Extremely sensitive - company crown jewels",sensitive:"Sensitive - PII, credit cards, ...",normal:"Normal",not_sensitive:"Not sensitive",no_data:"Not in use or no data"},me={extreme:"Internal Use Only",sensitive:"Restricted",normal:"Confidential",not_sensitive:"Public",no_data:"Not in use or no data"},pe=()=>k.data.featureflags.use_alt_repo_arch_sense?me:he,_e={components:{BaseModal:F,BaseButton:z,BaseParagraph:P,BaseHeading:q,BaseRadioInput:oe,BaseSelect:H,InputText:j,BaseForm:ae,XTooltip:X,SelectRepoOrCloudImage:re,XPreloader:G,ButtonMultiOption:de,SelectTeam:ue,NucleiTagSelector:le,AktoOpenapiSpecSelector:ce},props:{repository:{type:Object,default:null},image:{type:Object,default:null},enforceInternetConnected:{type:Boolean,default:!1},scanType:{type:String,default:"owasp-zap"}},emits:["close"],data(){return{architecture:null,internetExposedState:this.enforceInternetConnected?"connected":"unknown",domainNames:[""],sensitivity:"normal",domainNameErrors:[],linkedRepositoryError:void 0,isSaving:!1,isLoading:!0,selectedSCMRepository:null,selectedCloudRepository:null,architectureEffect:{scoreChange:0,aikidoAction:null},connectOptions:[{id:"none",title:"None"},{id:"scm_repo",title:"Repository"},{id:"cloud_image",title:"Container"}],selectedConnectOption:"none",linkedTeams:[],teams:[],tagGroups:[],devDepScanningEnabled:0,amountOfNucleiDomains:0,aktoSpecRuntimeServiceId:-1,aktoSpecCustomFileContent:null}},async created(){try{this.amountOfNucleiDomains=await Y(),this.image?(this.selectedConnectOption="cloud_image",await Promise.allSettled([this.loadImageArchitecture(),this.loadTeams()])):this.repository?(this.selectedConnectOption="scm_repo",await Promise.allSettled([this.loadRepoArchitecture(),this.loadTeams(),this.loadLinkedTeams()])):this.selectedConnectOption="none",this.repository&&this.repository.dev_dep_scanning_enabled&&(this.devDepScanningEnabled=this.repository.dev_dep_scanning_enabled),this.internetExposedState=this.architecture.internet_exposed,this.domainNames=this.architecture.domain_name.split(","),this.sensitivity=this.architecture.sensitivity}catch{}finally{this.isLoading=!1}},watch:{sensitivity(){this.fetchArchitecuteEffect()},internetExposedState(){this.fetchArchitecuteEffect()}},computed:{maxDomains(){return k.hasExpiredFullTrial()?1:this.$featureflags.enable_higher_linked_domain_limit?10:5},isAddDomainButtonDisabled(){return k.hasExpiredFullTrial()?!1:this.internetExposedState!=="connected"?!0:this.domainNames.length>=this.maxDomains},showUpgradeTooltip(){return k.hasExpiredFullTrial()&&this.domainNames.length>=1},repoName(){return this.image?this.image.name:this.repository?this.repository.scm_repo_name:null},headerText(){return this.image?"Configure container repository":this.repository?"Configure repository":"Add a domain"},hasAlreadyLinkedScmOrCloudRepo(){return!!this.repository||!!this.image},linkedSCMRepository(){return!this.repository&&!this.selectedSCMRepository?null:this.repository??this.selectedSCMRepository},linkedCloudRepository(){return!this.image&&!this.selectedCloudRepository?null:this.image??this.selectedCloudRepository},showArchitectureEffects(){return this.linkedSCMRepository||this.linkedCloudRepository},successToastDescription(){var t;return((t=this.$group)==null?void 0:t.scm_type)=="selfscan"?"The architecture for this repository has correctly been saved. Vulnerabilities will be updated on your next scan":"The architecture for this repository has correctly been saved. We'll start a scan to look for any vulnerabilities"},sensitivityOptions(){const t=pe();return Object.entries(t).map(([n,c])=>({id:n,title:c}))},shouldShowDevDepsOptions(){return!(!this.repository||!this.$featureflags.enable_option_for_dev_dep_scanning)},hasReachedMaxAmountNucleiDomains(){return this.$featureflags.enable_nuclei?!1:this.amountOfNucleiDomains>=1},submitButtonText(){return this.hasReachedMaxAmountNucleiDomains&&this.scanType=="nuclei"?"Request Access":"Finish"}},methods:{async loadTeams(){this.teams=await W()},async loadLinkedTeams(){this.linkedTeams=await Q(this.repository.id)},async loadImageArchitecture(){this.architecture=await J(this.image.id,{disable_toasts:!0})},async loadRepoArchitecture(){this.architecture=await K(this.repository.id,{disable_toasts:!0})},handleChangeConnectedToInternet(t){this.internetExposedState=t.target.value},handleChangeToDevDepScanning(t){this.devDepScanningEnabled=t.target.value},async handleSaveArchitecture(t){if(this.hasReachedMaxAmountNucleiDomains&&this.scanType=="nuclei"){this.openPrefilledIntercom();return}this.linkedRepositoryError=void 0,this.domainNameErrors=[],this.selectedConnectOption!="none"&&!this.linkedSCMRepository&&!this.linkedCloudRepository&&(this.linkedRepositoryError="You must link the domain to either a code repository or container");const n=this.domainNames.filter(c=>c!=="https://"&&c!=="");if(this.internetExposedState==="connected"&&n.length===0&&(this.domainNameErrors[0]="Please add at least one valid domain when the application is exposed to the internet"),this.domainNames.forEach((c,_)=>{c!==""&&this.domainNames.indexOf(c)!==_&&(this.domainNameErrors[_]="This domain is already linked to this reporsitory")}),!(this.domainNameErrors.length!==0||this.linkedRepositoryError!==void 0)){this.isSaving=!0;try{let c=null;if(this.scanType=="akto"||this.scanType=="akto_graphql"){await Promise.all(n.map(e=>x(e,this.scanType,[],this.aktoSpecCustomFileContent,this.aktoSpecRuntimeServiceId)));const _=this.scanType=="akto_graphql"?"akto_graphql_domain_added":"akto_domain_added";w(_)}else this.scanType=="nuclei"?(await Promise.all(n.map(_=>x(_,"nuclei",this.tagGroups))),w("nuclei_domain_added")):this.selectedConnectOption=="none"?await Promise.all(n.map(_=>x(_))):this.linkedCloudRepository?await Z({image_id:this.linkedCloudRepository.id,domain_name:n.join(","),sensitivity:this.sensitivity,internet_exposed:this.internetExposedState}):(await $(this.linkedSCMRepository.id,{domain_name:n.join(","),sensitivity:this.sensitivity,internet_exposed:this.internetExposedState,linked_teams:this.linkedTeams.map(_=>_.id),dev_dep_scanning_enabled:this.devDepScanningEnabled}),c={repositoryId:this.linkedSCMRepository.id,domain_name:n.join(","),sensitivity:this.sensitivity,internet_exposed:this.internetExposedState,dev_dep_scanning_enabled:this.devDepScanningEnabled});Toast.success({title:"Repo architecture saved!",description:this.successToastDescription}),this.$emit("saved",c)}finally{this.isSaving=!1}}},handleClose(){this.$emit("close")},handleAddDomain(){this.domainNames.length>=this.maxDomains||this.domainNames.push("")},handleRemoveDomain(t){this.domainNames.splice(t,1),this.domainNameErrors=[]},handleFocusDomain(t){this.domainNames[t].trim()==""&&(this.domainNames[t]="https://")},handleUnfocusDomain(t){this.domainNames[t].trim()=="https://"&&(this.domainNames[t]="")},handleTypingDomain(t,n){n.startsWith("https://https://")&&(n=n.replace("https://https://","https://")),this.domainNames[t]=n},async fetchArchitecuteEffect(){const t=await ee({internet_exposed:this.internetExposedState,sensitivity:this.sensitivity});this.architectureEffect.scoreChange=t.score_change,this.architectureEffect.aikidoAction=t.aikido_action},handleSelectSCMRepoOrCloudRepo(t){this.linkedRepositoryError=void 0,t.kind==="scm_repo"?(this.selectedCloudRepository=null,this.selectedSCMRepository=t.repository):(this.selectedSCMRepository=null,this.selectedCloudRepository=t.repository)},handleLinkTeam(t){this.linkedTeams=[...this.linkedTeams,t]},handleUnlinkTeam(t){this.linkedTeams=this.linkedTeams.filter(n=>n.id!=t)},openPrefilledIntercom(){const t="Hi, I would like to request more nuclei-powered domain scans.";window.Intercom("showNewMessage",t)}}},fe={class:"flex flex-column gap-2px"},ye={class:"flex flex-column gap-24px"},ge={class:"flex flex-column gap-8px"},Se={class:"text--semi-bold"},ke=s("hr",{class:"divider w-full"},null,-1),ve={class:"flex flex-column gap-8px"},Ce={class:"flex gap-8px align-center"},xe=s("label",{for:"unknown",class:"paragraph paragraph--small text-carbon-60 cursor-pointer"},"Unknown",-1),be=s("label",{for:"connected",class:"paragraph paragraph--small text-carbon-60 cursor-pointer"},"Yes",-1),Te=s("label",{for:"not_connected",class:"paragraph paragraph--small text-carbon-60 cursor-pointer"},"No",-1),Re=s("hr",{class:"divider w-full"},null,-1),we={class:"flex flex-column gap-8px"},Ee=s("i",{class:"icon icon-add"},null,-1),Ne=s("hr",{class:"divider w-full mt-8px"},null,-1),De={class:"flex flex-column gap-24px"},Ae={key:0,class:"flex flex-column gap-12px"},Ie={key:1,class:"flex flex-column gap-8px"},Be={key:2,class:"flex flex-column gap-8px"},Oe={key:0,class:"valign-middle icon icon-arrow-up text-color-danger mr-4px"},Me={key:1,class:"valign-middle icon icon-arrow-down text-color-success mr-4px"},Ue={class:"valign-middle"},Le={class:"text--semi-bold"},Ve={key:0},Fe=s("i",{class:"valign-middle icon icon-hidden text-carbon-80 mr-4px"},null,-1),ze=s("span",{class:"valign-middle"},[r(" We will auto ignore all issues with a "),s("span",{class:"text--semi-bold"},"low"),r(" and "),s("span",{class:"text--semi-bold"},"medium"),r(" severity. ")],-1),Pe=s("hr",{class:"divider w-full"},null,-1),qe={class:"flex flex-column gap-8px"},He={class:"flex gap-8px align-center"},je=s("label",{for:"dev_deps_enabled",class:"paragraph paragraph--small text-carbon-60 cursor-pointer"},"Yes",-1),Xe=s("label",{for:"dev_deps_disabled",class:"paragraph paragraph--small text-carbon-60 cursor-pointer"},"No",-1);function Ge(t,n,c,_,e,i){const h=d("BaseParagraph"),E=d("XPreloader"),T=d("BaseHeading"),N=d("SelectTeam"),g=d("BaseRadioInput"),R=d("InputText"),D=d("XTooltip"),v=d("BaseButton"),A=d("AktoOpenapiSpecSelector"),I=d("NucleiTagSelector"),B=d("ButtonMultiOption"),O=d("SelectRepoOrCloudImage"),M=d("BaseSelect"),U=d("BaseForm"),L=d("BaseModal");return a(),m(L,{width:650,onClose:i.handleClose,allowBackgroundClose:!1},{header:o(()=>{var p;return[s("div",fe,[(p=e.architecture)!=null&&p.updated_by_name?(a(),m(h,{key:0,size:"tiny",color:"subdued"},{default:o(()=>{var f;return[r("Last updated by: "+S(((f=e.architecture)==null?void 0:f.updated_by_name)??"test"),1)]}),_:1})):u("",!0)])]}),content:o(()=>[e.isLoading?(a(),m(E,{key:0,class:"supercenter",size:"medium"})):u("",!0),s("div",ye,[s("div",ge,[i.hasAlreadyLinkedScmOrCloudRepo?(a(),m(T,{key:0,as:"h3"},{default:o(()=>[r(" Configure settings for "),s("span",Se,S(i.repoName),1)]),_:1})):(a(),m(T,{key:1,as:"h3"},{default:o(()=>[r("Add Domain Details")]),_:1})),l(h,{size:"medium"},{default:o(()=>[r(" Configure your settings to finetune scanning and issue scoring. ")]),_:1})]),!i.linkedCloudRepository&&e.teams.length>0?(a(),m(N,{key:0,onLinkTeam:i.handleLinkTeam,onUnlinkTeam:i.handleUnlinkTeam,"linked-teams":e.linkedTeams,teams:e.teams,"repository-name":i.repoName},null,8,["onLinkTeam","onUnlinkTeam","linked-teams","teams","repository-name"])):u("",!0),ke,l(U,{id:"architecture",onSubmit:te(i.handleSaveArchitecture,["prevent"])},{default:o(()=>[c.enforceInternetConnected?u("",!0):(a(),y(b,{key:0},[s("div",ve,[l(h,{size:"medium",bold:""},{default:o(()=>[r("Is this service connected to the internet via http(s)?")]),_:1}),l(h,{size:"small",color:"subdued"},{default:o(()=>[r(" Does this code run in an internet-connected server? ")]),_:1}),s("div",Ce,[l(g,{name:"internet_connected",id:"unknown",value:"unknown",onSelect:i.handleChangeConnectedToInternet,checked:e.internetExposedState==="unknown",required:""},null,8,["onSelect","checked"]),xe,l(g,{name:"internet_connected",id:"connected",value:"connected",onSelect:i.handleChangeConnectedToInternet,checked:e.internetExposedState==="connected",required:""},null,8,["onSelect","checked"]),be,l(g,{name:"internet_connected",id:"not_connected",value:"not_connected",onSelect:i.handleChangeConnectedToInternet,checked:e.internetExposedState==="not_connected",required:""},null,8,["onSelect","checked"]),Te])]),Re],64)),s("div",we,[l(h,{size:"medium",bold:""},{default:o(()=>[r(" Domain Name")]),_:1}),e.internetExposedState!=="connected"?(a(),m(R,{key:0,placeholder:"Domain name",disabled:""})):(a(!0),y(b,{key:1},ie(e.domainNames,(p,f)=>(a(),m(R,{key:f,placeholder:"Domain name",modelValue:e.domainNames[f],"onUpdate:modelValue":C=>i.handleTypingDomain(f,C),name:"domainName",type:"url",error:e.domainNameErrors[f],clearable:e.domainNames.length>1,onClear:()=>i.handleRemoveDomain(f),onFocus:C=>i.handleFocusDomain(f),onBlur:C=>i.handleUnfocusDomain(f)},null,8,["modelValue","onUpdate:modelValue","error","clearable","onClear","onFocus","onBlur"]))),128)),i.hasAlreadyLinkedScmOrCloudRepo?(a(),m(v,{key:2,variation:"plain",size:"small",onClick:i.handleAddDomain,class:"align-self-center mt-8px",disabled:i.isAddDomainButtonDisabled},{default:o(()=>[Ee,r(" Add related domain "),i.showUpgradeTooltip?(a(),m(D,{key:0},{default:o(()=>[r("Upgrade plan to add up to 5 domains")]),_:1})):u("",!0)]),_:1},8,["onClick","disabled"])):u("",!0),Ne]),c.scanType=="akto"?(a(),m(A,{key:1,runtimeServiceId:e.aktoSpecRuntimeServiceId,"onUpdate:runtimeServiceId":n[0]||(n[0]=p=>e.aktoSpecRuntimeServiceId=p),customSpecFileContent:e.aktoSpecCustomFileContent,"onUpdate:customSpecFileContent":n[1]||(n[1]=p=>e.aktoSpecCustomFileContent=p)},null,8,["runtimeServiceId","customSpecFileContent"])):u("",!0),c.scanType=="nuclei"?(a(),m(I,{key:2,modelValue:e.tagGroups,"onUpdate:modelValue":n[2]||(n[2]=p=>e.tagGroups=p)},null,8,["modelValue"])):u("",!0),ne(s("div",null,[s("div",De,[i.hasAlreadyLinkedScmOrCloudRepo?u("",!0):(a(),y("div",Ae,[l(h,{size:"medium",bold:""},{default:o(()=>[r("Link domain to an asset")]),_:1}),l(h,{size:"small",color:"subdued"},{default:o(()=>[r(" Link the domain to a code repository or cloud image so that we can group the issues accordingly. ")]),_:1}),l(B,{class:"issue-detail__card__questionaire__answer",options:e.connectOptions,modelValue:e.selectedConnectOption,"onUpdate:modelValue":n[3]||(n[3]=p=>e.selectedConnectOption=p)},null,8,["options","modelValue"]),e.selectedConnectOption!="none"?(a(),m(O,{key:0,class:"mt-8px",onSelectRepository:i.handleSelectSCMRepoOrCloudRepo,error:e.linkedRepositoryError,onlyShowRepo:e.selectedConnectOption=="scm_repo",onlyShowCloud:e.selectedConnectOption=="cloud_image"},null,8,["onSelectRepository","error","onlyShowRepo","onlyShowCloud"])):u("",!0)])),e.selectedConnectOption!="none"?(a(),y("div",Ie,[l(h,{size:"medium",bold:""},{default:o(()=>[r(" How sensitive is the data managed by this service? ")]),_:1}),l(h,{size:"small",color:"subdued"},{default:o(()=>[r(" If this service handles things like credits card info, PII, healthcare data, or financial data we can treat these vulnerabilities with more care. ")]),_:1}),l(M,{options:i.sensitivityOptions,modelValue:e.sensitivity,"onUpdate:modelValue":n[4]||(n[4]=p=>e.sensitivity=p),required:"",disabled:!t.$groupUser.can_change_issue_severity},null,8,["options","modelValue","disabled"])])):u("",!0),i.showArchitectureEffects&&e.architectureEffect.scoreChange!=0?(a(),y("div",Be,[l(h,{size:"medium",bold:""},{default:o(()=>[r(" How will this configuration affect your scans? ")]),_:1}),l(h,{size:"medium"},{default:o(()=>[e.architectureEffect.scoreChange>0?(a(),y("i",Oe)):(a(),y("i",Me)),s("span",Ue,[r(" We will update your issue severity with a score change of "),s("span",Le,[e.architectureEffect.scoreChange>0?(a(),y("span",Ve,"+")):u("",!0),r(S(e.architectureEffect.scoreChange),1)])])]),_:1}),e.architectureEffect.aikidoAction=="autoignore"?(a(),m(h,{key:0,size:"medium"},{default:o(()=>[Fe,ze]),_:1})):u("",!0)])):u("",!0)])],512),[[se,c.scanType=="owasp-zap"]]),i.shouldShowDevDepsOptions?(a(),y(b,{key:3},[Pe,s("div",qe,[l(h,{size:"medium",bold:""},{default:o(()=>[r("Scan developer dependencies")]),_:1}),l(h,{size:"small",color:"subdued"},{default:o(()=>[r(" If enabled, this can result in a lot of false positives. ")]),_:1}),s("div",He,[l(g,{name:"dev_deps_enabled",id:"dev_deps_enabled",value:"1",onSelect:i.handleChangeToDevDepScanning,checked:e.devDepScanningEnabled==1,required:""},null,8,["onSelect","checked"]),je,l(g,{name:"dev_deps_enabled",id:"dev_deps_disabled",value:"0",onSelect:i.handleChangeToDevDepScanning,checked:e.devDepScanningEnabled==0,required:""},null,8,["onSelect","checked"]),Xe])])],64)):u("",!0)]),_:1},8,["onSubmit"])])]),footer:o(()=>[l(v,{variation:"tertiary",onClicked:i.handleClose,class:"ml-auto"},{default:o(()=>[r("Cancel")]),_:1},8,["onClicked"]),l(v,{variation:"primary",type:"submit",form:"architecture",disabled:e.isLoading,isLoading:e.isSaving},{default:o(()=>[r(S(i.submitButtonText),1)]),_:1},8,["disabled","isLoading"])]),_:1},8,["onClose"])}const st=V(_e,[["render",Ge]]);export{st as default};
