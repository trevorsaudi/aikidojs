import{P as M}from"./PageHeader-46c38a32.js";import{_ as C,B as k,J as O,r as o,q as u,m as _,o as l,w as d,n as i,u as T,s as h,S as N,a0 as v,du as j,H as V,cF as A,X as U,k as g,F as B,t as X,bk as q,V as z,N as G,f as $,d as Y,x as W,an as P,Q as J,p as x,c7 as K}from"./index-13ff96f4.js";import{P as Q}from"./ProgressTracker-672a1ecc.js";import{B as Z}from"./BaseCallout-aea0aba4.js";import{L as ee}from"./languages-12749071.js";const te={components:{BaseParagraph:k,AvatarImage:O},emits:["selectItem"],props:{historyItem:{type:Object,required:!0},selected:{type:Boolean,default:!1}},computed:{dateString(){console.log(this.historyItem);const r=this.historyItem.timestamp,e=new Date(r*1e3),s=e.toLocaleString("default",{month:"long"}),c=e.getDate(),t=`${e.getHours()}:${e.getMinutes()}`;return`${s} ${c}, ${t}`}}},se={class:"text--semi"},re={class:"flex"};function ie(r,e,s,c,t,a){const p=o("BaseParagraph"),y=o("AvatarImage");return u(),_("div",{class:N(["py-24px px-40px hover_bg-primary-aik-20 border-l-2 cursor-pointer",{"bg-primary-aik-20 border-primary-aik-100":s.selected,"border-transparent":!s.selected}]),onClick:e[0]||(e[0]=S=>r.$emit("selectItem"))},[l(p,{color:"dark-gray",size:"large",class:"mb-4px"},{default:d(()=>[i("span",se,T(a.dateString),1)]),_:1}),i("div",re,[l(y,{class:"size-18 inline-block",name:s.historyItem.by_who_name,src:s.historyItem.avatar},null,8,["name","src"]),l(p,{class:"ml-8px",color:"gray",size:"medium"},{default:d(()=>[h(T(s.historyItem.by_who_name),1)]),_:1})])],2)}const oe=C(te,[["render",ie]]),le=async({rule:r,issue_title:e,tldr:s,how_to_fix:c,language:t,priority:a})=>{const p={rule:r,issue_title:e,tldr:s,how_to_fix:c,language:t,priority:a};await v.post("/api/sast/custom_rule/add",p)},ae=async({rule_id:r,rule:e,issue_title:s,tldr:c,how_to_fix:t,language:a,priority:p})=>{const y={rule_id:r,rule:e,issue_title:s,tldr:c,how_to_fix:t,language:a,priority:p};await v.post("/api/sast/custom_rule/edit",y)},ne=async r=>{const e={rule_id:r};await v.post("/api/sast/custom_rule/delete",e)},ue=async r=>(await v.get(`/api/sast/custom_rule/${r}`)).data,de=async r=>(await v.get(`/api/sast/custom_rule/${r}/history`)).data,ce={components:{XModal:j,BaseHeading:V,InputTextArea:A,XPreloader:U,CustomRuleHistoryListItem:oe,BaseParagraph:k},emits:["close"],props:{rule_id:{type:Number,required:!0}},data(){return{ruleHistoryItems:[],selectedItem:null,loading:!0}},async mounted(){this.loading=!0;const r=await de(this.rule_id);this.ruleHistoryItems=r.custom_rule_history_items,this.selectedItem=this.ruleHistoryItems[0]||null,this.loading=!1},methods:{triggerClose(){this.$emit("close")}}},pe={class:"modal-header py-32px px-40px"},me=i("i",{class:"icon icon-12px icon-close"},null,-1),he=[me],ge={class:"flex justify-between h-500px rounded-b-12px border-t-carbon-20 overflow-hidden"},ye={class:"w-75p py-36px px-40px"},_e={class:"w-25p h-full border-l-carbon-20"},fe={class:"overflow-y-auto max-h-500px"},xe={key:2,class:"p-32px"};function ve(r,e,s,c,t,a){const p=o("BaseHeading"),y=o("XPreloader"),S=o("InputTextArea"),w=o("CustomRuleHistoryListItem"),R=o("BaseParagraph"),f=o("XModal");return u(),g(f,{modalClass:"p-0",width:1325,maxWidth:"1325",allowBackgroundClose:!0,onClose:a.triggerClose},{default:d(()=>[i("div",pe,[l(p,{as:"h3"},{default:d(()=>[h("Version History")]),_:1}),i("button",{onClick:e[0]||(e[0]=(...m)=>a.triggerClose&&a.triggerClose(...m)),class:"modal-header__close-button"},he)]),i("div",ge,[t.loading?(u(),g(y,{key:0,size:"medium",class:"absolute-centered"})):t.ruleHistoryItems.length>0?(u(),_(B,{key:1},[i("div",ye,[l(S,{title:"Opengrep Rule",modelValue:t.selectedItem.rule,disabled:!0,rows:"20",name:"opengrepRule"},null,8,["modelValue"])]),i("div",_e,[i("div",fe,[(u(!0),_(B,null,X(t.ruleHistoryItems,m=>(u(),g(w,{key:m.id,historyItem:m,selected:t.selectedItem.id==m.id,onSelectItem:I=>t.selectedItem=m},null,8,["historyItem","selected","onSelectItem"]))),128))])])],64)):(u(),_("div",xe,[l(R,{size:"large",bold:!0},{default:d(()=>[h("No history available for this custom rule")]),_:1})]))])]),_:1},8,["onClose"])}const Se=C(ce,[["render",ve]]),we={components:{PageHeader:M,BaseHeading:V,ProgressTracker:Q,BaseBody:q,InputTextArea:A,InputText:z,BaseSelect:G,BaseButton:$,BasePill:Y,BaseCallout:Z,BaseIcon:W,BaseParagraph:k,CustomRuleVersionHistoryModal:Se},data(){return{breadcrumbs:[{label:"Repositories",href:"/repositories"},{label:"Checks",href:"/repositories/sast"},{label:"Add custom SAST Rule"}],rulePlaceHolder:`Copy / paste the generated rule from Opengrep here

rules:
- id: bad-eval
  pattern: eval(...)
  message: Opengrep found a match
  languages: [python]
  severity: WARNING`,rule:"",issueTitle:"",tldr:"",howToFix:"",language:null,priority:null,isCopyPastingRule:!1,error:{},isEditPage:!1,customRuleId:null,isLoading:!1,customRuleError:null,lastEditText:"",shouldSeeVersionHistoryModal:!1,isDeletingRule:!1}},async mounted(){this.isLoading=!0;const{customRuleId:r}=this.$route.params;if(!r){this.isEditPage=!1,this.isLoading=!1;return}const s=(await ue(r)).custom_rule;this.rule=s.rule,this.issueTitle=s.issue_title,this.tldr=s.tldr,this.howToFix=s.how_to_fix,this.language=s.language,this.priority=s.priority,this.customRuleError=s.error,this.lastEditText=this.getlastEditText(s),this.customRuleId=r,this.isEditPage=!0,this.isLoading=!1},computed:{steps(){return[{title:"Create rule in Opengrep",completed:this.createRuleStatus.completed,pending:this.createRuleStatus.pending},{title:"Copy/paste Opengrep rule",completed:this.copyPasteRuleStatus.completed,pending:this.copyPasteRuleStatus.pending},{title:"Fill in details to display in Aikido",completed:this.fillDetailsStatus.completed,pending:this.fillDetailsStatus.pending}]},languageOptions(){const r=Object.entries(ee).map(([s,c])=>({id:s,title:c})),e=[{id:"terraform",title:"Terraform"},{id:"generic",title:"Generic"}];for(const s of e)r.push(s);return r},createRuleStatus(){return this.isCopyPastingRule?{completed:!0,pending:!1}:this.copyPasteRuleStatus.pending||this.copyPasteRuleStatus.completed?{completed:!0,pending:!1}:{completed:!1,pending:!0}},copyPasteRuleStatus(){return this.isCopyPastingRule?{completed:!1,pending:!0}:this.rule!==""?{completed:!0,pending:!1}:{completed:!1,pending:!1}},fillDetailsStatus(){return!this.createRuleStatus.completed||!this.copyPasteRuleStatus.completed?{completed:!1,pending:!1}:[this.rule,this.issueTitle,this.tldr,this.howToFix,this.language,this.priority].some(s=>s?(s+"").trim()=="":!0)?{completed:!1,pending:!0}:{completed:!0,pending:!1}},priorityError(){return this.error.priority?this.error.priority:this.priority<0||this.priority>100?"Score should be between 0 and 100":null},severity(){return this.priority==null||this.priority==""?null:this.$severity.low_min<=this.priority&&this.priority<=this.$severity.low_max?{color:"green",text:"Low"}:this.$severity.medium_min<=this.priority&&this.priority<=this.$severity.medium_max?{color:"blue",text:"Medium"}:this.$severity.high_min<=this.priority&&this.priority<=this.$severity.high_max?{color:"orange",text:"High"}:this.$severity.critical_min<=this.priority&&this.priority<=this.$severity.critical_max?{color:"red",text:"Critical"}:null},ruleErrorDescription(){return!this.isEditPage||!this.customRuleError?"":this.customRuleError.error_msgs.join(`
`)}},methods:{async saveRule(){this.error={};const r={rule:{value:this.rule,title:"Rule"},issueTitle:{value:this.issueTitle,title:"Issue title"},tldr:{value:this.tldr,title:"TL;DR"},howToFix:{value:this.howToFix,title:"How to fix"},language:{value:this.language,title:"Language"},priority:{value:this.priority,title:"Score"}};for(const[e,s]of Object.entries(r))s.value||(this.error[e]=`${s.title} cannot be empty`);if(!(Object.values(this.error).length>0)&&!this.priorityError){if(this.isEditPage){await this.editCustomSastRule();return}await le({rule:this.rule,issue_title:this.issueTitle,tldr:this.tldr,how_to_fix:this.howToFix,language:this.language,priority:this.priority}),this.$toast.success({title:"Custom SAST rule created",description:"Your custom SAST rule is created successfully. Aikido will take this rule into account next scan."}),this.$router.push("/repositories/sast")}},async editCustomSastRule(){await ae({rule_id:this.customRuleId,rule:this.rule,issue_title:this.issueTitle,tldr:this.tldr,how_to_fix:this.howToFix,language:this.language,priority:this.priority}),this.$toast.success({title:"Custom SAST rule edited",description:"Your custom SAST rule is edited successfully. Aikido will take this rule into account on the next scan."}),P.emit("customSastRuleUpdated"),this.$router.push("/repositories/sast")},async deleteRule(){await J({headerText:"Custom Rule Deletion",title:"Custom Rule Deletion",description:"Removing this rule will also clear out all related issues from your feed. Are you sure you want to continue?",buttonSubmitText:"Delete Custom Rule"})&&(this.isDeletingRule=!0,await ne(this.customRuleId),this.isDeletingRule=!1,P.emit("customSastRuleDeleted"),this.$toast.success({title:"Successfully deleted custom SAST rule.",description:"Custom SAST rule and all related issues were successfully deleted."}),this.$router.push("/repositories/sast"))},getlastEditText(r){let s=`Last edit: ${this.getDate(r.last_updated_at)}`;return r.updated_by_name&&(s+=` by ${r.updated_by_name}`),s},getDate(r){const e=new Date(r*1e3),s=e.getDay()+"",c=e.getMonth()+1+"";return`${e.getFullYear()}/${c.padStart(2,"0")}/${s.padStart(2,"0")}`}}},Re={class:"flex gap-8px align-center"},be={key:1,class:"page-content bg-white"},Te={class:"flex justify-between"},Ce={class:"w-70p pr-100px"},ke={class:"mt-48px field"},Ie=i("div",{class:"flex justify-between"},[i("label",{for:"text-area-opengrepRule"},"Opengrep rule"),i("a",{href:"https://github.com/opengrep/opengrep-playground?tab=readme-ov-file#installation",target:"_blank",class:"link"},"Test in Opengrep playground")],-1),Be={class:"mt-48px"},Pe={class:"mt-48px"},Ve={class:"mt-48px"},Ae={class:"mt-48px flex gap-24px justify-between"},Ee={class:"mt-24px flex gap-16px justify-end py-10px"},He=i("span",null,"Delete Rule",-1),De={class:"w-30p"},Le={class:"sticky pin-t-88px"},Fe={class:"mt-36px max-w-280px mx-auto"},Me={key:0,class:"mt-8px max-w-280px mx-auto"};function Oe(r,e,s,c,t,a){const p=o("BaseHeading"),y=o("PageHeader"),S=o("XPreloader"),w=o("BaseCallout"),R=o("BaseBody"),f=o("InputTextArea"),m=o("InputText"),I=o("BaseSelect"),E=o("BasePill"),H=o("BaseIcon"),b=o("BaseButton"),D=o("ProgressTracker"),L=o("BaseParagraph"),F=o("CustomRuleVersionHistoryModal");return u(),_("div",null,[l(y,{breadcrumbs:t.breadcrumbs},{title:d(()=>[i("div",Re,[l(p,{as:"h1"},{default:d(()=>[h("SAST Checks")]),_:1})])]),_:1},8,["breadcrumbs"]),t.isLoading?(u(),g(S,{key:0,class:"absolute-centered",size:"medium"})):(u(),_("div",be,[a.ruleErrorDescription?(u(),g(w,{key:0,title:"This rule caused errors and is no longer used when scanning. Please check and edit the rule.",description:a.ruleErrorDescription,variation:"danger",class:"mb-24px",allowNewlinesInDescription:!0},null,8,["description"])):x("",!0),i("div",Te,[i("div",Ce,[l(p,{as:"h3"},{default:d(()=>[h("Add your custom SAST rule")]),_:1}),l(R,{class:"mt-8px",color:"subdued"},{default:d(()=>[h("Add a specific SAST rules that you want to see popping up in Aikido.")]),_:1}),i("div",ke,[Ie,l(f,{placeholder:t.rulePlaceHolder,modelValue:t.rule,"onUpdate:modelValue":e[0]||(e[0]=n=>t.rule=n),modelModifiers:{trim:!0},rows:"16",name:"opengrepRule",error:t.error.rule,onFocus:e[1]||(e[1]=n=>t.isCopyPastingRule=!0),onBlur:e[2]||(e[2]=n=>t.isCopyPastingRule=!1)},null,8,["placeholder","modelValue","error"])]),i("div",Be,[l(m,{title:"Issue title",placeholder:"Issue title...",modelValue:t.issueTitle,"onUpdate:modelValue":e[3]||(e[3]=n=>t.issueTitle=n),modelModifiers:{trim:!0},required:!1,name:"issueTitle",error:t.error.issueTitle},null,8,["modelValue","error"])]),i("div",Pe,[l(f,{title:"TL;DR",placeholder:"Give a short summary of this type of issue...",modelValue:t.tldr,"onUpdate:modelValue":e[4]||(e[4]=n=>t.tldr=n),modelModifiers:{trim:!0},rows:"5",required:!1,name:"tldr",error:t.error.tldr},null,8,["modelValue","error"])]),i("div",Ve,[l(f,{title:"How do I fix it?",placeholder:"Explain how to fix",modelValue:t.howToFix,"onUpdate:modelValue":e[5]||(e[5]=n=>t.howToFix=n),modelModifiers:{trim:!0},rows:"5",required:!1,name:"howToFix",error:t.error.howToFix},null,8,["modelValue","error"])]),i("div",Ae,[l(I,{class:"flex-1",id:"language",label:"Language",modelValue:t.language,"onUpdate:modelValue":e[6]||(e[6]=n=>t.language=n),options:a.languageOptions,placeholder:"Select...",error:t.error.language},null,8,["modelValue","options","error"]),l(m,{type:"number",class:"flex-1",id:"priority",title:"Score",modelValue:t.priority,"onUpdate:modelValue":e[7]||(e[7]=n=>t.priority=n),placeholder:"78",min:0,max:100,error:a.priorityError,hideSpinner:!0},K({_:2},[a.severity?{name:"extraLabel",fn:d(()=>[l(E,{class:"h-full",variation:a.severity.color,title:a.severity.text},null,8,["variation","title"])]),key:"0"}:void 0]),1032,["modelValue","error"])]),i("div",Ee,[t.isEditPage?(u(),g(b,{key:0,isLoading:t.isDeletingRule,variation:"destructive",class:"mr-auto",onClick:a.deleteRule},{default:d(()=>[l(H,{icon:"icon-delete",color:"#f9f9f9",class:"mb-2px"}),He]),_:1},8,["isLoading","onClick"])):x("",!0),l(b,{variation:"plain",onClick:e[8]||(e[8]=()=>r.$router.go(-1))},{default:d(()=>[h("Back")]),_:1}),l(b,{onClick:a.saveRule},{default:d(()=>[h("Save Rule")]),_:1},8,["onClick"])])]),i("div",De,[i("div",Le,[l(D,{steps:a.steps},null,8,["steps"]),i("div",Fe,[t.lastEditText?(u(),g(L,{key:0,color:"subdued",class:"text--semi"},{default:d(()=>[h(T(t.lastEditText),1)]),_:1})):x("",!0)]),t.isEditPage?(u(),_("div",Me,[i("div",{class:"link",onClick:e[9]||(e[9]=n=>t.shouldSeeVersionHistoryModal=!0)},"Show Version History")])):x("",!0)])])])])),t.shouldSeeVersionHistoryModal?(u(),g(F,{key:2,rule_id:t.customRuleId,onClose:e[10]||(e[10]=n=>t.shouldSeeVersionHistoryModal=!1)},null,8,["rule_id"])):x("",!0)])}const ze=C(we,[["render",Oe]]);export{ze as default};
