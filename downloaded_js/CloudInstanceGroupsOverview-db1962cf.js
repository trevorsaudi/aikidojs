import{_ as y,B as P,d as N,a2 as B,r as o,q as r,k as d,w as e,o as n,n as h,s as p,u as f,p as G,ai as z,m as S,ah as O,A as V,a1 as R,f as F,x as U,an as _,a0 as $,aw as H,dQ as j,dR as X,dS as W,F as w,t as D}from"./index-13ff96f4.js";import{u as q}from"./useTableSorting-22e45d25.js";import{D as Q,a as Y}from"./DataTable-e31a825a.js";import{u as A}from"./useInstanceGroupScanningProgress-7091a8e2.js";import{a as J,b as K}from"./dateFns-a344cb79.js";import{D as E,a as T}from"./DataTableCell-51c0104f.js";import{C as Z,s as nn}from"./scanningLimits-8d03a4e6.js";import{D as en}from"./DataTableSeverityIndicator-48ffb8dc.js";import{C as k}from"./ContainersIllustration-8126771c.js";import{O as L}from"./OverviewEmptyState-c8440b9c.js";import{_ as tn}from"./ripples-df807ff5.js";import"./tableSortingCache-ca369cac.js";import"./index-b87db690.js";import"./ActionMenu-3e4470bf.js";const sn={props:{instanceGroup:Object,cloudId:[String,Number]},components:{BaseParagraph:P,BasePill:N,CloudInstanceGroupActionMenu:Z,DataTableCell:E,DataTableRow:T,DataTableSeverityIndicator:en,XTooltip:B},setup(){const{registerInstanceGroup:t,scanningProgress:l}=A();return{registerInstanceGroup:t,scanningProgress:l}},mounted(){this.registerInstanceGroup(this.instanceGroup.external_id)},computed:{href(){return this.instanceGroupIsDisabled?null:`/clouds/${this.cloudId}/virtual-machines/${this.instanceGroup.id}`},isScanning(){var t;return!this.scanningProgress||!this.instanceGroup.active?!1:((t=this.scanningProgress)==null?void 0:t.status)==="scanning"},scanningProgressValue(){var t;return(t=this.scanningProgress)==null?void 0:t.progress},scanningProgressMessage(){var t,l;return(t=this.scanningProgress)!=null&&t.progressMessageCode?this.$t(`VIRTUAL_MACHINES_SCANNING_PROGRESS_MESSAGE_${(l=this.scanningProgress)==null?void 0:l.progressMessageCode}`):null},isScanned(){return!!this.instanceGroup.last_scanned_at&&this.instanceGroup.last_scanned_at>0},formattedTimestamp(){return this.isScanned?J(this.instanceGroup.last_scanned_at):"No scan yet"},formattedTimestampForMobile(){return this.isScanned?this.$t("REPO_OVERVIEW.LAST_ACTIVITY",{time:K(this.instanceGroup.last_scanned_at)}):"No scan yet"},instanceGroupIsDisabled(){return!this.instanceGroup.active},environment(){return this.instanceGroup.cloud_purpose!="mixed"?null:this.instanceGroup.environment},hardDriveSizeGb(){const t=this.instanceGroup.hard_drive_size_in_gb;if(!t)return null;const l=parseInt(t,10);return isNaN(l)?null:l},hardDriveSizeLimitGb(){var t;return((t=nn[this.instanceGroup.cloud_kind])==null?void 0:t.maxHardDriveSizeGb)??0},isUnscannableDueToHardDriveSize(){return this.instanceGroup.cloud_kind!=="azure"||!this.hardDriveSizeGb?!1:this.hardDriveSizeGb>this.hardDriveSizeLimitGb}},methods:{handleOpenEditInstanceGroupPurposeModal(){this.$modal.show("EditCloudInstanceGroupPurposeModal",{cloudId:this.cloudId,instanceGroup:this.instanceGroup})}}},an={class:"flex flex-column gap-8px justify-between flex-1"},on={class:"flex align-center gap-4px"},cn=h("div",{class:"shimmer shimmer--blue"},null,-1),rn=[cn],ln=h("i",{class:"icon icon-information icon-12px leading-14px"},null,-1),un={class:"hidden sm:block"},dn={class:"block sm:hidden"};function pn(t,l,i,g,m,s){const a=o("BaseParagraph"),c=o("BasePill"),u=o("DataTableCell"),b=o("DataTableSeverityIndicator"),v=o("XTooltip"),C=o("CloudInstanceGroupActionMenu"),x=o("DataTableRow");return r(),d(x,{clickable:"",href:s.href,disabled:s.instanceGroupIsDisabled},{default:e(()=>[n(u,null,{default:e(()=>[h("div",an,[n(a,null,{default:e(()=>[p(f(i.instanceGroup.name),1)]),_:1}),h("div",on,[s.scanningProgressMessage?(r(),d(c,{key:0,variation:"gray-fill",title:s.scanningProgressMessage},null,8,["title"])):G("",!0),n(c,{variation:"gray-fill",title:i.instanceGroup.region},null,8,["title"]),n(c,{variation:"gray-fill",class:"wide-tablet_hidden",title:t.$t("X_VM_INSTANCES",i.instanceGroup.instance_count)},null,8,["title"]),s.environment?(r(),d(c,{key:1,variation:"gray-fill",title:s.environment},null,8,["title"])):G("",!0)])])]),_:1}),n(u,null,{default:e(()=>[n(a,null,{default:e(()=>[p(f(i.instanceGroup.count_open_issues),1)]),_:1})]),_:1}),n(u,null,{default:e(()=>[n(a,null,{default:e(()=>[p(f(i.instanceGroup.count_ignored_issues),1)]),_:1})]),_:1}),n(b,{priority:i.instanceGroup.max_issue_severity},null,8,["priority"]),n(u,null,{default:e(()=>[i.instanceGroup.purpose?(r(),d(a,{key:0},{default:e(()=>[p(f(i.instanceGroup.purpose),1)]),_:1})):(r(),d(c,{key:1,class:"cursor-pointer",icon:"icon-settings",title:"Configure",variation:"gray-fill",onClick:z(s.handleOpenEditInstanceGroupPurposeModal,["prevent"])},null,8,["onClick"]))]),_:1}),n(u,{class:"desktop-medium_data-table__column__folded"},{default:e(()=>[s.isScanning?(r(),S("div",{key:0,class:"loading-bar",style:O({width:`${s.scanningProgressValue}%`})},rn,4)):i.instanceGroup.active&&s.isUnscannableDueToHardDriveSize?(r(),d(a,{key:1,class:"inline-flex align-center gap-2px"},{default:e(()=>[p(" No scan "),ln,n(v,null,{default:e(()=>[p("We are unable to scan this hard drive because it's size of "+f(s.hardDriveSizeGb)+"GB exceeds the limit of "+f(s.hardDriveSizeLimitGb)+"GB",1)]),_:1})]),_:1})):i.instanceGroup.active?(r(),d(a,{key:2,class:"truncate"},{default:e(()=>[h("span",un,f(s.formattedTimestamp),1),h("span",dn,f(s.formattedTimestampForMobile),1)]),_:1})):G("",!0)]),_:1}),n(C,{"instance-group":i.instanceGroup,"cloud-id":i.cloudId},null,8,["instance-group","cloud-id"])]),_:1},8,["href","disabled"])}const hn=y(sn,[["render",pn]]),_n={props:{cloud:Object,instanceGroupCount:Number},components:{OverviewEmptyState:L,ContainersIllustration:k},computed:{description(){return this.instanceGroupCount>1?`Aikido can scan your ${this.instanceGroupCount} VM instances for open-source dependencies, EOL runtimes and licences.`:"Aikido can scan your VM instances for open-source dependencies, EOL runtimes and licences."}},methods:{handleConnectAccount(){if(!(this.$featureflags.aws_ebs_scanning||this.$featureflags.azure_vm_scanning)&&!V.isPayingAndNoProTrial())return this.$modal.show("UpgradeAccountModal",{title:"Upgrade to set up Virtual Machine Scanning",msg:"Upgrade now to any paying plan to start using VM scanning."});this.$router.push(`/side-scanning/${this.cloud.id}/connect/${this.cloud.type}`)}}};function mn(t,l,i,g,m,s){const a=o("ContainersIllustration"),c=o("OverviewEmptyState");return r(),d(c,{title:"Activate Virtual Machine Scanning",description:s.description,actionLabel:"Set Up VM Scanning",onOnAction:s.handleConnectAccount},{default:e(()=>[n(a)]),_:1},8,["description","onOnAction"])}const gn=y(_n,[["render",mn]]),fn={props:{cloudId:[Number,String]},components:{OverviewEmptyState:L,ContainersIllustration:k},methods:{handleDiscoverInstanceGroups(){}}},Gn=h("div",{class:"mt-12px -mb-16px"},[h("img",{src:tn,width:"30"})],-1);function Sn(t,l,i,g,m,s){const a=o("ContainersIllustration"),c=o("OverviewEmptyState");return r(),d(c,{title:"No instances discovered yet",description:"Discovering instances...",variation:"empty"},{subdescription:e(()=>[Gn]),default:e(()=>[n(a)]),_:1})}const yn=y(fn,[["render",Sn]]),In={components:{DataTableCell:E,DataTableRow:T,LoadingSkeleton:R}},bn={class:"w-full flex flex-column gap-8px"},vn={class:"w-200px flex gap-4px"};function Cn(t,l,i,g,m,s){const a=o("LoadingSkeleton"),c=o("DataTableCell"),u=o("DataTableRow");return r(),d(u,null,{default:e(()=>[n(c,null,{default:e(()=>[h("div",bn,[n(a,{height:"16px"}),h("div",vn,[n(a,{height:"16px"}),n(a,{height:"16px"})])])]),_:1}),n(c,null,{default:e(()=>[n(a,{height:"16px"})]),_:1}),n(c,null,{default:e(()=>[n(a,{height:"16px"})]),_:1}),n(c,null,{default:e(()=>[n(a,{height:"16px"})]),_:1}),n(c,null,{default:e(()=>[n(a,{height:"16px"})]),_:1}),n(c,null,{default:e(()=>[n(a,{height:"16px"})]),_:1}),n(c,null,{default:e(()=>[n(a,{height:"16px"})]),_:1})]),_:1})}const xn=y(In,[["render",Cn]]),wn={props:{cloud:Object},components:{BaseButton:F,BaseIcon:U,CloudInstanceGroupNoAccountConnectedEmptyState:gn,CloudInstanceGroupEmptyState:yn,CloudInstanceGroupRow:hn,CloudInstanceGroupRowLoading:xn,DataTable:Q,DataTableHeader:Y},data(){return{hasEnabledSideScanning:!0,isLoading:!0,instanceGroups:[],emptyStateInstanceGroupCount:0}},setup(){const{sorting:t,handleChangeSorting:l}=q(),{addListener:i,removeListener:g}=A();return{sorting:t,handleChangeSorting:l,addInstanceGroupScanningListener:i,removeInstanceGroupScanningListener:g}},created(){_.on("side-scanning-instance-group-created",this.getAllInstanceGroupsDebounced),this.addInstanceGroupScanningListener(),_.on("side-scanning-instance-group-deactivated",this.reloadInstanceGroups),_.on("side-scanning-instance-group-activated",this.reloadInstanceGroups),_.on("instanceGroupPurposeUpdated",this.getAllInstanceGroups),_.on("sideScanningAccountDisconnected",this.handleAccountDisconnected),_.on("virtualMachineScanCompleted",this.getAllInstanceGroups)},beforeUnmount(){_.off("side-scanning-instance-group-created",this.getAllInstanceGroupsDebounced),this.removeInstanceGroupScanningListener(),_.off("side-scanning-instance-group-deactivated",this.reloadInstanceGroups),_.off("side-scanning-instance-group-activated",this.reloadInstanceGroups),_.off("instanceGroupPurposeUpdated",this.getAllInstanceGroups),_.off("sideScanningAccountDisconnected",this.handleAccountDisconnected),_.off("virtualMachineScanCompleted",this.getAllInstanceGroups)},async mounted(){try{await this.getAllInstanceGroups()}catch(t){$.isAxiosError(t)&&t.response.status===404&&(this.hasEnabledSideScanning=!1,await this.getEmptyStateInstanceGroupCount())}finally{this.isLoading=!1}},watch:{async sorting(){this.reloadInstanceGroups()}},computed:{showEmptyState(){return!this.isLoading&&this.hasEnabledSideScanning&&this.instanceGroups.length===0},showNoAccountConnectedEmptyState(){return!this.isLoading&&!this.hasEnabledSideScanning}},methods:{getAllInstanceGroupsDebounced:H(async function(){this.getAllInstanceGroups()},500),async getAllInstanceGroups(){var t,l;this.instanceGroups=await j({cloud_id:this.cloud.id},{disable_toasts:!0,sort_by_column:(t=this.sorting)==null?void 0:t.column,sort_by_direction:(l=this.sorting)==null?void 0:l.direction})},async getEmptyStateInstanceGroupCount(){const t=await X(this.cloud.id);this.emptyStateInstanceGroupCount=t.count},async handleDiscoverInstance(){await W(this.cloud.id),this.$toast.success({title:"Scan started",description:"A scan to discover instance groups was started successfully. We'll report back soon"})},async handleDisconnectAccount(){this.$modal.show("DisconnectSideScanningAccountModal",{cloud_id:this.cloud.id})},async handleAccountDisconnected(){this.instanceGroups=[],this.hasEnabledSideScanning=!1},async reloadInstanceGroups(){this.$globalLoadingIndicator.show();try{await this.getAllInstanceGroups()}finally{this.$globalLoadingIndicator.hide()}}}},Dn={class:"flex flex-1 mb-16px"},An={class:"flex gap-8px align-center ml-auto"},En=h("span",{class:"text--semi-bold"},"Disconnect VMs",-1),Tn={key:1,colspan:"7"};function kn(t,l,i,g,m,s){const a=o("BaseIcon"),c=o("BaseButton"),u=o("DataTableHeader"),b=o("CloudInstanceGroupRow"),v=o("CloudInstanceGroupRowLoading"),C=o("CloudInstanceGroupNoAccountConnectedEmptyState"),x=o("CloudInstanceGroupEmptyState"),M=o("DataTable");return r(),S(w,null,[h("div",Dn,[h("div",An,[m.hasEnabledSideScanning?(r(),d(c,{key:0,size:"small",variation:"filter",onClick:s.handleDisconnectAccount},{default:e(()=>[n(a,{icon:"icon-delete",size:"12",class:"icon-12px"}),En]),_:1},8,["onClick"])):G("",!0),m.hasEnabledSideScanning?(r(),d(c,{key:1,size:"small",variation:"primary",onClick:s.handleDiscoverInstance},{default:e(()=>[p(" Scan VMs ")]),_:1},8,["onClick"])):G("",!0)])]),n(M,null,{header:e(()=>[n(u,{width:"auto"},{default:e(()=>[p("Name")]),_:1}),n(u,{width:"90px"},{default:e(()=>[p("# Open")]),_:1}),n(u,{width:"100px"},{default:e(()=>[p("# Ignored")]),_:1}),n(u,{width:"113px",alignment:"center","sort-by":"max_issue_severity",sorted:g.sorting.column==="max_issue_severity",onSort:g.handleChangeSorting,"inverted-sorting":""},{default:e(()=>[p("Severity")]),_:1},8,["sorted","onSort"]),n(u,{width:"25%"},{default:e(()=>[p("Purpose")]),_:1}),n(u,{width:"115px",class:"desktop-medium_data-table__column__folded"},{default:e(()=>[p("Last scan")]),_:1}),n(u,{width:"48px",alignment:"center"})]),body:e(()=>[(r(!0),S(w,null,D(m.instanceGroups,I=>(r(),d(b,{key:I.id,"instance-group":I,"cloud-id":i.cloud.id},null,8,["instance-group","cloud-id"]))),128)),m.isLoading?(r(),S(w,{key:0},D(6,I=>n(v,{key:I})),64)):G("",!0),s.showNoAccountConnectedEmptyState||s.showEmptyState?(r(),S("td",Tn,[s.showNoAccountConnectedEmptyState?(r(),d(C,{key:0,cloud:i.cloud,instanceGroupCount:m.emptyStateInstanceGroupCount},null,8,["cloud","instanceGroupCount"])):s.showEmptyState?(r(),d(x,{key:1,cloud:i.cloud},null,8,["cloud"])):G("",!0)])):G("",!0)]),_:1})],64)}const Xn=y(wn,[["render",kn]]);export{Xn as default};
