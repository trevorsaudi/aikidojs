import{_ as U,r as n,q as i,k as f,w as t,o as e,e as D,Q as x,eh as H,an as g,ei as q,aa as Q,a1 as W,m,t as $,F as L,a2 as Y,B as G,al as J,d as K,f as Z,z as ee,I as te,d$ as R,e0 as se,aw as ne,n as c,p as h,ej as oe,s as l,u as p,ai as C}from"./index-13ff96f4.js";import{a as A,D as E}from"./DataTableCell-51c0104f.js";import{a as M,D as ae}from"./DataTable-e31a825a.js";import{R as ie}from"./RuntimeNoTokenCallout-f395432e.js";import{X as re}from"./XPagination-8f16f099.js";import{I as le}from"./InputFilterDropdown-674351d9.js";import{O as ce}from"./OverviewEmptyState-c8440b9c.js";import{R as de}from"./RuntimeIllustration-4912df3a.js";import{A as ue}from"./ActionMenu-3e4470bf.js";import{u as me}from"./useInfiniteScroll-47c60c9e.js";import{a as _e}from"./dateFns-a344cb79.js";import{B as he}from"./BaseCallout-aea0aba4.js";import"./FilterButton-bb5393a7.js";import"./index-b87db690.js";const pe={emits:["viewInstructions"],components:{RuntimeIllustration:de,OverviewEmptyState:ce},computed:{title(){return"No users found"},description(){return"Identify users to block malicious activity and enhance rate limiting accuracy for better security and control."},actionLabel(){return"View install instructions"}}};function fe(r,o,v,b,_,a){const u=n("RuntimeIllustration"),d=n("OverviewEmptyState");return i(),f(d,{title:a.title,description:a.description,actionLabel:a.actionLabel,variation:"empty",onOnAction:o[0]||(o[0]=y=>r.$emit("viewInstructions"))},{default:t(()=>[e(u)]),_:1},8,["title","description","actionLabel"])}const be=U(pe,[["render",fe]]),ge={components:{BaseIconButton:D,ActionMenu:ue},props:{user:{type:Object,required:!0}},computed:{actions(){return[{title:"Actions",items:[{hidden:!this.user.blocked,label:"Unblock User",onClick:this.handleUnblock,icon:"icon-tick-circle"},{hidden:this.user.blocked,label:"Block User",onClick:this.handleBlock,svgIcon:"block"}].filter(o=>!o.hidden)}]},disableAction(){return this.actions[0].items.length===0}},methods:{async handleUnblock(){await x({headerText:"Unblock user",description:"Are you sure you want to unblock this user?",buttonSubmitText:"Unblock User"})&&(await H({serviceId:this.user.service_id,userId:this.user.user_id}),g.emit("runtime.users.unblocked"))},async handleBlock(){await x({headerText:"Block user",description:"Are you sure you want to block this user?",buttonSubmitText:"Block User"})&&(await q({serviceId:this.user.service_id,userId:this.user.user_id}),g.emit("runtime.users.blocked"))}}};function ve(r,o,v,b,_,a){const u=n("ActionMenu");return i(),f(u,{sections:a.actions,placement:"bottom-end",useBaseIcon:""},{trigger:t(d=>[Q(r.$slots,"trigger",{toggle:d.toggle,disabled:a.disableAction})]),_:3},8,["sections"])}const ke=U(ge,[["render",ve]]),we={components:{DataTableHeader:M,DataTableRow:A,DataTableCell:E,LoadingSkeleton:W}};function Ie(r,o,v,b,_,a){const u=n("LoadingSkeleton"),d=n("DataTableCell"),y=n("DataTableRow");return i(),m(L,null,$(6,S=>e(y,{key:S},{default:t(()=>[e(d,null,{default:t(()=>[e(u,{height:"22px"})]),_:1}),e(d,null,{default:t(()=>[e(u,{height:"22px"})]),_:1}),e(d,null,{default:t(()=>[e(u,{height:"22px"})]),_:1}),e(d,null,{default:t(()=>[e(u,{height:"22px"})]),_:1}),e(d)]),_:2},1024)),64)}const ye=U(we,[["render",Ie]]),Ue={components:{RuntimeUserRowSkeleton:ye,BaseCallout:he,XTooltip:Y,BaseParagraph:G,LoadingSpinner:J,BaseIconButton:D,RuntimeUserActions:ke,RuntimeUsersEmptyState:be,InputFilterDropdown:le,RuntimeNoTokenCallout:ie,BasePill:K,DataTable:ae,DataTableCell:E,DataTableHeader:M,BaseButton:Z,DataTableRow:A,XPagination:re,InputSwitch:ee,InputSearch:te},setup(){const{records:r,fetch:o,reset:v,watchElement:b,isLoading:_}=me(oe,50,a=>a);return{users:r,isFetchingRecords:_,listUsersInfScroll:o,reloadUsersInfScroll:v,watchElement:b}},data(){return{initialLoading:!0,loading:!0,search:"",cutOffTime:R(new Date)}},computed:{serviceId(){return this.$route.params.serviceId},enrichedUsers(){return this.users.map(r=>({...r,status:r.blocked?{label:"Blocked",color:"red"}:{label:"Active",color:"green"},last_seen_at_relative:_e(r.last_seen_at)}))},shouldShowEmptyState(){return!this.loading&&this.users.length===0},listUsersParameters(){return{serviceId:this.serviceId,search:this.search,cutOffTime:this.cutOffTime}}},created(){g.on("runtime.users.blocked",this.reloadUsers),g.on("runtime.users.unblocked",this.reloadUsers)},beforeUnmount(){g.off("runtime.users.blocked",this.reloadUsers),g.off("runtime.users.unblocked",this.reloadUsers)},async mounted(){if(await this.$nextTick(),await Promise.all([this.loadUsers(),this.loadService()]),!this.service){this.$router.push("/runtime/services");return}this.$breadcrumbs.show({breadcrumbs:[{label:this.$t("RUNTIME_PROTECTION"),href:"/runtime"},{label:this.service.name}]}),this.watchElement(this.$refs.tableBottom,{threshold:0,rootMargin:"1000px"}),this.loading=!1},methods:{viewInstructionsClicked(){this.service&&this.service.agent?this.$modal.show("RuntimeMiddlewareInstructionsModal",{serviceId:this.serviceId}):this.$modal.show("RuntimeInstallInstructionsModal",{serviceId:this.serviceId})},installMiddlewareClicked(){this.$modal.show("RuntimeMiddlewareInstructionsModal",{serviceId:this.serviceId})},async reloadUsers(){this.cutOffTime=R(new Date),await this.reloadUsersInfScroll(this.listUsersParameters)},async loadUsers(){await this.listUsersInfScroll(this.listUsersParameters),this.initialLoading=!1},async loadService(){this.service=await se(this.serviceId)},handleFilterChanged:ne(async function(){this.loading=!0,await this.reloadUsers(),this.loading=!1},400)}},Se={class:"flex flex-column gap-16px"},Te={key:0,class:"mb-24px"},Be={class:"mb-16px flex align-center justify-between"},xe={class:"flex gap-8px"},Re={class:"flex gap-8px"},Ce=c("i",{class:"icon icon-information"},null,-1),De={key:0,class:"ml-4px"},$e={class:"text-gray-200"},Le={key:0},Ae={class:"flex align-center justify-between w-full"},Ee={key:0,class:"ml-8px"},Me=["src","alt"],Pe={key:0},Oe={colspan:"5"},Fe={ref:"tableBottom"},Ve={key:0,class:"data-table__bottom"},Ne=c("hr",null,null,-1),Xe={key:0,class:"flex align-center gap-8px"},je=c("hr",null,null,-1);function ze(r,o,v,b,_,a){const u=n("RuntimeNoTokenCallout"),d=n("BaseCallout"),y=n("InputSearch"),S=n("BaseButton"),k=n("DataTableHeader"),P=n("RuntimeUserRowSkeleton"),w=n("BaseParagraph"),T=n("XTooltip"),I=n("DataTableCell"),O=n("BasePill"),F=n("BaseIconButton"),V=n("RuntimeUserActions"),B=n("DataTableRow"),N=n("RuntimeUsersEmptyState"),X=n("DataTable"),j=n("LoadingSpinner");return i(),m("div",Se,[c("div",null,[e(u,{serviceId:a.serviceId},null,8,["serviceId"]),r.service&&r.service.agent&&!r.service.agent.middleware_installed?(i(),m("div",Te,[e(d,{title:"Set up user tracking",description:"You need to install the middleware to track & block users.",actionLabel:"Show instructions",onAction:a.installMiddlewareClicked,variation:"warning"},null,8,["onAction"])])):h("",!0),c("div",Be,[c("div",xe,[e(y,{modelValue:_.search,"onUpdate:modelValue":[o[0]||(o[0]=s=>_.search=s),a.handleFilterChanged],spacing:"compact",disableDebounce:!0},null,8,["modelValue","onUpdate:modelValue"])]),c("div",Re,[e(S,{as:"'button'",size:"small",variation:"tertiary",onClick:o[1]||(o[1]=s=>r.$modal.show("RuntimeMiddlewareInstructionsModal",{serviceId:this.serviceId}))},{default:t(()=>[Ce,l(" User Tracking Instructions ")]),_:1})])]),e(X,null,{header:t(()=>[e(k,{width:"auto"},{default:t(()=>[l("ID")]),_:1}),e(k,{width:"250px"},{default:t(()=>[l("Last IP Address")]),_:1}),e(k,{width:"120px"},{default:t(()=>[l("Status")]),_:1}),e(k,{width:"150px"},{default:t(()=>[l("Last Seen At")]),_:1}),e(k,{width:"48px"})]),body:t(()=>[_.initialLoading?(i(),f(P,{key:0})):h("",!0),(i(!0),m(L,null,$(a.enrichedUsers,s=>(i(),f(B,{key:s.id,class:"text-blue-dark"},{default:t(()=>[e(I,null,{default:t(()=>[e(w,{class:"truncate"},{default:t(()=>[l(p(s.user_id)+" ",1),s.user_name?(i(),m("span",De,[l(" | "),c("span",$e,p(s.user_name),1)])):h("",!0)]),_:2},1024),e(T,null,{default:t(()=>[l(p(s.user_id)+" ",1),s.user_name?(i(),m("span",Le," | "+p(s.user_name),1)):h("",!0)]),_:2},1024)]),_:2},1024),e(I,null,{default:t(()=>[c("div",Ae,[e(w,{class:"truncate"},{default:t(()=>[l(p(s.last_ip_address),1)]),_:2},1024),e(T,null,{default:t(()=>[l(p(s.last_ip_address),1)]),_:2},1024),s.location?(i(),m("div",Ee,[c("img",{class:"rounded-2px valign-top",src:`https://aikido-production-staticfiles-public.s3.eu-west-1.amazonaws.com/flags/${s.location.country.iso_code.toLowerCase()}.svg`,height:"14",alt:s.location.country.name},null,8,Me),e(T,null,{default:t(()=>[s.location.country?(i(),m("span",Pe,p(s.location.country.name),1)):h("",!0)]),_:2},1024)])):h("",!0)])]),_:2},1024),e(I,null,{default:t(()=>[s.status?(i(),f(O,{key:0,title:s.status.label,variation:s.status.color,class:"text--capitalize"},null,8,["title","variation"])):h("",!0)]),_:2},1024),e(I,null,{default:t(()=>[e(w,null,{default:t(()=>[l(p(s.last_seen_at_relative),1)]),_:2},1024)]),_:2},1024),e(I,{spacing:"compact",alignment:"center"},{default:t(()=>[c("div",{class:"data-table__row__action-container",onClick:o[3]||(o[3]=C(()=>{},["prevent","stop"]))},[e(V,{user:s},{trigger:t(z=>[e(F,{onClick:o[2]||(o[2]=C(()=>{},["prevent","stop"])),onClicked:z.toggle,icon:"icon-actions",ref_for:!0,ref:"trigger",class:"data-table__row__action"},null,8,["onClicked"])]),_:2},1032,["user"])])]),_:2},1024)]),_:2},1024))),128)),a.shouldShowEmptyState?(i(),f(B,{key:1},{default:t(()=>[c("td",Oe,[e(N,{onViewInstructions:a.viewInstructionsClicked},null,8,["onViewInstructions"])])]),_:1})):h("",!0)]),_:1}),c("div",Fe,[!_.loading&&!a.shouldShowEmptyState?(i(),m("div",Ve,[Ne,b.isFetchingRecords?(i(),m("div",Xe,[e(j,{color:"#6551F3",backgroundColor:"#E0DCFD"}),e(w,{color:"gray"},{default:t(()=>[l("Hang on, we're fetching more users for you")]),_:1})])):(i(),f(w,{key:1,color:"gray"},{default:t(()=>[l("We have no more users to show")]),_:1})),je])):h("",!0)],512)])])}const at=U(Ue,[["render",ze]]);export{at as default};
