import{_ as P,X as v,B as U,a2 as B,d as k,an as a,bA as _,a3 as S,A as R,bg as M,dL as x,c6 as z,r as n,k as f,m as u,o as i,w as c,n as d,p as h,S as b,F as $,q as r,ah as X,s as C,u as D}from"./index-13ff96f4.js";import{i as H}from"./configurationIssues-06890829.js";import{P as F}from"./PageHeader-46c38a32.js";import{X as K}from"./XTabs-d492da26.js";import V from"./DeleteCloudModal-fcf43857.js";import{N as G}from"./NoAccess-b1a75b5c.js";import{B as W}from"./BaseCallout-aea0aba4.js";import{b as j}from"./dateFns-a344cb79.js";import{g as q}from"./scans-7651948f.js";import"./index-b87db690.js";const J={components:{PageHeader:F,XTabs:K,XPreloader:v,BaseCallout:W,DeleteCloudModal:V,BaseParagraph:U,XTooltip:B,BasePill:k,NoAccess:G},data(){return{loaded:!1,cloud:void 0,meta:null,issues:[],tab:this.$route.name,scanningProgress:null,showDeleteCloudModal:!1,hasNoAccess:!1}},created(){a.on(_,this.handleCloudScanEvent),a.on("cloudDeleted",this.handleCloudDeletedEvent),a.on("configurationIssueIgnored",this.loadData),a.on("cloudEdited",this.loadData)},beforeUnmount(){a.off(_,this.handleCloudScanEvent),a.off("cloudDeleted",this.handleCloudDeletedEvent),a.off("configurationIssueIgnored",this.loadData),a.off("cloudEdited",this.loadData)},async mounted(){await this.loadData(),this.loaded=!0},watch:{async cloudId(){this.cloudId&&(await this.loadData(),this.scanningProgress=null)},tab(){this.$router.push({name:this.tab})},"$route.name"(){this.tab=this.$route.name}},computed:{cloudName(){return this.cloud?this.cloud.name:"Cloud"},cloudId(){return this.$route.params.id},subtitle(){return`${this.cloud.open_issues} issues`},breadcrumbs(){const e=[{label:"Clouds",href:"/clouds"},{label:this.cloudName}];return this.tab==="cloudDetailChecks"&&e.push({label:this.$t("CHECKS")}),this.tab==="cloudDetailImages"&&e.push({label:this.$t("CLOUD_IMAGES")}),this.tab==="cloudDetailAssets"&&e.push({label:this.$t("CLOUD_ASSETS")}),this.tab==="cloudDetailSideScanning"&&e.push({label:this.$t("CLOUD_DETAIL.TABS.INSTANCE_GROUPS")}),e},isScanning(){return!!this.scanningProgress&&this.scanningProgress>0&&this.scanningProgress<100},isNotAccessible(){return!!this.invalidCredentialsConfigurationIssueId},invalidCredentialsConfigurationIssueId(){const e=this.cloud.configuration_issues.find(s=>s.kind==="cloud_credentials_invalid"&&s.status==="open");return(e==null?void 0:e.id)??void 0},lastScan(){var e;return(e=this.meta)!=null&&e.last_scanned_at?`Last scan ${j(this.meta.last_scanned_at)} ago`:"No scans just yet"},nextScanTime(){var e;return(e=this.meta)!=null&&e.next_scan_at?`Next scan on ${S.fromUnix(this.meta.next_scan_at).format(S.SHORT_DATE_FORMAT)}`:null},cloudKindIcon(){return this.cloud.type==="azure"?"icon-azure":this.cloud.type==="gcp"?"icon-gcp":this.cloud.type==="digocean"?"icon-digitalocean":"icon-location_aws"},cloudKindLabel(){return this.cloud.type==="azure"?"Azure":this.cloud.type==="gcp"?"GCP":this.cloud.type==="digocean"?"Digital Ocean":"AWS"},cloudKindUrl(){return this.cloud.type==="azure"?"https://portal.azure.com/#home":this.cloud.type==="gcp"?`https://console.cloud.google.com/welcome?project=${this.cloud.account_id}`:this.cloud.type==="digocean"?"https://cloud.digitalocean.com/":`https://${this.cloud.account_id}.signin.aws.amazon.com/console`},tabs(){var o;const e=[{title:this.$t("ISSUES"),id:"cloudDetailIssues"},{title:this.$t("CLOUD_DETAIL.TABS.CHECKS"),id:"cloudDetailChecks"}];(o=this.cloud)!=null&&o.has_registry_connected||e.push({title:this.$t("CLOUD_CONTAINERS"),id:"cloudDetailImages"});const s=["aws","azure"],l=this.$featureflags.aws_ebs_scanning||this.$featureflags.azure_vm_scanning;return s.includes(this.cloud.type)&&l&&e.push({title:this.$t("CLOUD_DETAIL.TABS.INSTANCE_GROUPS"),id:"cloudDetailSideScanning"}),["aws","azure"].includes(this.cloud.type)&&e.push({title:this.$t("CLOUD_ASSETS"),id:"cloudDetailAssets"}),e},showScanButtonInHeader(){return this.tab!=="cloudDetailSideScanning"}},methods:{async handleStartScan(){if(this.scanningProgress=null,R.hasExpiredFullTrial())return this.$modal.show("UpgradeAccountModal");await M(this.cloud.id,"scan"),Toast.success({title:this.$t("NOTIFICATIONS.SCAN_STARTED.TITLE"),description:"We started the cloud scan successfully, we'll report the issues back soon."})},async loadCloudDetails(){var e,s;try{this.cloud=await x(this.$route.params.id)}catch(l){if(l instanceof z.AxiosError){if(((e=l.response)==null?void 0:e.status)===404){this.$router.push({name:"notFound"});return}if(((s=l.response)==null?void 0:s.status)===498){this.hasNoAccess=!0;return}}Toast.error({title:this.$t("ERROR"),description:"We are currently unable to load the details of this cloud"}),this.$router.back()}},async loadCloudMeta(){this.meta=await q("cloud",this.cloudId)},async loadData(){await Promise.allSettled([this.loadCloudDetails(),this.loadCloudMeta()])},async handleCloudScanEvent(e){const{type:s,progress:l,cloudId:g}=e;if(`${g}`===this.cloudId)if(s==="progress_update"){if((this.scanningProgress??0)>l)return;this.scanningProgress=l}else s==="completed"?(this.scanningProgress=100,a.emit("cloudScanFinished"),await this.loadData()):s==="failure"&&(this.scanningProgress=null,Toast.error({title:this.$t("ERROR"),description:"We were unable to complete the scan for this cloud"}),await this.loadData())},handleShowDeleteCloudModal(){this.showDeleteCloudModal=!0},handleHideDeleteCloudModal(){this.showDeleteCloudModal=!1},handleCloudDeletedEvent(e){e===this.cloud.id&&this.$router.replace("/clouds")},async handleIgnoreConfigurationIssue(){await H(this.invalidCredentialsConfigurationIssueId),a.emit("configurationIssueIgnored")},async handleConfigureCloud(){(await this.$modal.show("ConfigureCloudModal",{cloud:this.cloud,show:!0})).type==="delete"&&await this.$modal.show("DeleteCloudModal",{show:!0,cloud:this.cloud})==="cancel"&&this.$modal.hide()}}},Q={class:"flex gap-8px"},Y=["href"],Z={key:0,class:"loading-overlay"},ee=d("div",{class:"shimmer shimmer--purple shimmer--rtl"},null,-1),te=[ee],se=d("i",{class:"icon icon-calender icon-12px valign-middle ml-8px"},null,-1),oe={key:0,class:"mb-24px"};function ae(e,s,l,g,o,t){const T=n("XPreloader"),y=n("NoAccess"),m=n("BasePill"),A=n("XTabs"),I=n("XTooltip"),w=n("BaseParagraph"),N=n("PageHeader"),E=n("BaseCallout"),O=n("router-view"),L=n("DeleteCloudModal");return o.loaded?o.hasNoAccess?(r(),f(y,{key:1,type:"cloud"})):(r(),u($,{key:2},[i(N,{breadcrumbs:t.breadcrumbs,title:t.cloudName},{subTitle:c(()=>[d("div",Q,[i(m,{title:t.subtitle,variation:"green"},null,8,["title"]),i(m,{class:"cursor-pointer",icon:"icon-settings",title:"Configure",variation:"gray-fill",onClick:t.handleConfigureCloud},null,8,["onClick"]),d("a",{href:t.cloudKindUrl,target:"_blank"},[i(m,{icon:t.cloudKindIcon,title:t.cloudKindLabel,variation:"gray-fill"},null,8,["icon","title"])],8,Y)])]),rightContent:c(()=>[t.showScanButtonInHeader?(r(),u("button",{key:0,class:b(["button-brand button--primary button--rounded button--normal button--border button--with-progress",[t.isScanning&&"button--in-progress"]]),onClick:s[0]||(s[0]=(...p)=>t.handleStartScan&&t.handleStartScan(...p))},[t.isScanning?(r(),u("div",Z,[d("div",{class:"loading-bar",style:X({width:`${o.scanningProgress}%`})},te,4)])):h("",!0),C(" Start scan ")],2)):h("",!0)]),tabs:c(()=>[i(A,{tabs:t.tabs,modelValue:o.tab,"onUpdate:modelValue":s[1]||(s[1]=p=>o.tab=p),class:"page-tabs"},null,8,["tabs","modelValue"])]),footerRightContent:c(()=>[o.meta?(r(),f(w,{key:0,color:"subdued"},{default:c(()=>[C(D(t.lastScan)+" ",1),se,i(I,null,{default:c(()=>[C(D(t.nextScanTime),1)]),_:1})]),_:1})):h("",!0)]),_:1},8,["breadcrumbs","title"]),d("div",{class:b(["page-content",[t.isNotAccessible&&"pt-32px"]])},[t.isNotAccessible?(r(),u("div",oe,[i(E,{title:e.$t("CALLOUTS.CLOUD.CLOUD_NOT_CONNECTED.TITLE"),description:e.$t("CALLOUTS.CLOUD.CLOUD_NOT_CONNECTED.DESCRIPTION"),actionLabel:e.$t("CALLOUTS.CLOUD.CLOUD_NOT_CONNECTED.ACTION_LABEL"),onAction:t.handleShowDeleteCloudModal,secondaryActionLabel:"ignore",onSecondaryAction:t.handleIgnoreConfigurationIssue,variation:"danger"},null,8,["title","description","actionLabel","onAction","onSecondaryAction"])])):h("",!0),i(O,{cloud:o.cloud},null,8,["cloud"])],2),i(L,{show:o.showDeleteCloudModal,onCancel:t.handleHideDeleteCloudModal,cloud:o.cloud},null,8,["show","onCancel","cloud"])],64)):(r(),f(T,{key:0,class:"supercenter",theme:"transparent"}))}const pe=P(J,[["render",ae]]);export{pe as default};
