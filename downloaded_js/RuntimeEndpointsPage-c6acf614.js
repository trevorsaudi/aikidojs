import{_ as x,r as a,q as l,k as _,w as e,o as t,e as $,ee as S,an as I,Q as P,ef as j,aa as G,a1 as Q,m as h,t as L,F as M,a2 as W,d as Y,f as Z,z as J,I as K,B as tt,e0 as et,aw as it,a3 as A,n as r,p as f,eg as nt,s as c,u as p,ai as C}from"./index-13ff96f4.js";import{a as q,D as V}from"./DataTableCell-51c0104f.js";import{a as N,D as ot}from"./DataTable-e31a825a.js";import{R as at}from"./RuntimeNoTokenCallout-f395432e.js";import{X as st}from"./XPagination-8f16f099.js";import{I as lt}from"./InputFilterDropdown-674351d9.js";import{O as rt}from"./OverviewEmptyState-c8440b9c.js";import{R as ct}from"./RuntimeIllustration-4912df3a.js";import{g as dt}from"./service-39b61fa2.js";import{A as ut}from"./ActionMenu-3e4470bf.js";import{u as mt}from"./useInfiniteScroll-47c60c9e.js";import{B as ht}from"./BaseCallout-aea0aba4.js";import{R as pt}from"./RuntimeBarChart-79838118.js";import"./FilterButton-bb5393a7.js";import"./index-fdfd2f30.js";const _t={emits:["viewInstructions"],components:{RuntimeIllustration:ct,OverviewEmptyState:rt},computed:{title(){return"No routes found"},description(){return"Zen automatically collects your API route definitions"},actionLabel(){return"View install instructions"}}};function ft(i,o,g,b,m,s){const d=a("RuntimeIllustration"),u=a("OverviewEmptyState");return l(),_(u,{title:s.title,description:s.description,actionLabel:s.actionLabel,variation:"empty",onOnAction:o[0]||(o[0]=R=>i.$emit("viewInstructions"))},{default:e(()=>[t(d)]),_:1},8,["title","description","actionLabel"])}const gt=x(_t,[["render",ft]]),vt={components:{BaseIconButton:$,ActionMenu:ut},props:{endpoint:{type:Object,required:!0}},computed:{actions(){const i=!!this.endpoint.graphql;return[{title:"Actions",items:[{hidden:!1,label:"Setup Rate Limiting",onClick:this.handleSetupRateLimiting,svgIcon:"speedometer"},{hidden:i,label:"IP Allowlist",onClick:this.handleIPAllowlist,svgIcon:"allow-list-ip"},{hidden:this.endpoint.protected||i,label:"Enable Protection",onClick:this.handleEnableProtection,icon:"icon-shield_check"},{hidden:!this.endpoint.protected||i,label:"Disable Protection",onClick:this.handleDisableProtection,icon:"icon-shield_check"},{hidden:!this.endpoint.created_manually,label:"Delete",onClick:this.handleDelete,icon:"icon-delete",iconColor:"red",destructive:!0}].filter(g=>!g.hidden)}]},disableAction(){return this.actions[0].items.length===0}},methods:{async handleIPAllowlist(){await this.$modal.show("UpdateRuntimeEndpointIPAllowlistModal",{endpoint:this.endpoint})},async handleSetupRateLimiting(){await this.$modal.show("UpdateRuntimeEndpointModal",{endpoint:this.endpoint})},async handleEnableProtection(){await S({serviceId:this.endpoint.service_id,method:this.endpoint.method,route:this.endpoint.route,forceProtectionOff:!1}),this.$toast.success("Protection enabled for route. It might take a while to reflect on your instances."),I.emit("runtime.endpoint.updated")},async handleDisableProtection(){await P({headerText:"Disable Protection",description:"Are you sure you want to disable protection for this route?",buttonSubmitText:"Disable Protection"})&&(await S({serviceId:this.endpoint.service_id,method:this.endpoint.method,route:this.endpoint.route,forceProtectionOff:!0}),this.$toast.success("Protection disabled for route. It might take a while to reflect on your instances."),I.emit("runtime.endpoint.updated"))},async handleDelete(){await P({headerText:"Delete Route",description:"Are you sure you want to delete this route?",buttonSubmitText:"Delete Route"})&&(await j({serviceId:this.endpoint.service_id,endpointId:this.endpoint.id}),this.$toast.success("Route deleted successfully. It might take a while to reflect on your instances."),I.emit("runtime.endpoint.updated"))}}};function wt(i,o,g,b,m,s){const d=a("ActionMenu");return l(),_(d,{sections:s.actions,placement:"bottom-end",useBaseIcon:""},{trigger:e(u=>[G(i.$slots,"trigger",{toggle:u.toggle,disabled:s.disableAction})]),_:3},8,["sections"])}const bt=x(vt,[["render",wt]]),yt={components:{DataTableHeader:N,DataTableRow:q,DataTableCell:V,LoadingSkeleton:Q}};function It(i,o,g,b,m,s){const d=a("LoadingSkeleton"),u=a("DataTableCell"),R=a("DataTableRow");return l(),h(M,null,L(6,k=>t(R,{key:k},{default:e(()=>[t(u,null,{default:e(()=>[t(d,{height:"22px"})]),_:1}),t(u,null,{default:e(()=>[t(d,{height:"22px"})]),_:1}),t(u,null,{default:e(()=>[t(d,{height:"22px"})]),_:1}),t(u,null,{default:e(()=>[t(d,{height:"22px"})]),_:1}),t(u,null,{default:e(()=>[t(d,{height:"22px"})]),_:1}),t(u)]),_:2},1024)),64)}const Rt=x(yt,[["render",It]]),kt="https://cdn.aikido.dev/assets/icons/graphql.svg",xt={components:{RuntimeEndpointRowSkeleton:Rt,RuntimeBarChart:pt,BaseCallout:ht,XTooltip:W,RuntimeEndpointActions:bt,BaseIconButton:$,RuntimeEndpointsEmptyState:gt,InputFilterDropdown:lt,RuntimeNoTokenCallout:at,BasePill:Y,DataTable:ot,DataTableCell:V,DataTableHeader:N,BaseButton:Z,DataTableRow:q,XPagination:st,InputSwitch:J,InputSearch:K,BaseParagraph:tt},setup(){const{records:i,isLoading:o,fetch:g,reset:b,refresh:m,watchElement:s}=mt(nt,100,d=>d,{stopPaginationBehaviour:"eager"});return{endpoints:i,isFetchingRecords:o,fetchEndpoints:g,resetEndpoints:b,refreshEndpoints:m,watchElement:s}},data(){return{initialLoading:!0,loading:!0,service:void 0,search:"",formatter:new Intl.NumberFormat("en-US",{notation:"compact",compactDisplay:"short",maximumFractionDigits:1})}},computed:{serviceId(){return this.$route.params.serviceId},shouldShowEmptyState(){return!this.loading&&this.endpoints.length===0},enrichedEndpoints(){return this.service?this.endpoints.map(i=>{let o=dt(this.service);return i.protected||(o={label:"Forced off",color:"orange"}),{...i,status:o}}):[]}},created(){I.on("runtime.endpoint.updated",this.loadEndpoints)},beforeUnmount(){I.off("runtime.endpoint.updated",this.loadEndpoints)},async mounted(){if(await Promise.all([this.loadEndpoints(),this.loadService()]),this.loading=!1,!this.service){this.$router.push("/runtime/services");return}this.$breadcrumbs.show({breadcrumbs:[{label:this.$t("RUNTIME_PROTECTION"),href:"/runtime"},{label:this.service.name}]}),await this.$nextTick(),this.watchElement(this.$refs.tableBottom,{threshold:0,rootMargin:"400px"})},methods:{viewInstructionsClicked(){this.service&&this.service.agent?this.$modal.show("RuntimeMiddlewareInstructionsModal",{serviceId:this.serviceId}):this.$modal.show("RuntimeInstallInstructionsModal",{serviceId:this.serviceId})},installMiddlewareClicked(){this.$modal.show("RuntimeMiddlewareInstructionsModal",{serviceId:this.serviceId})},async loadEndpoints(){await this.resetEndpoints({serviceId:this.serviceId,search:this.search}),this.initialLoading=!1},async loadService(){this.service=await et(this.serviceId)},convertWindowSizeInMSToHuman(i){return i===60*1e3?"minute":i===10*60*1e3?"10 minutes":i===30*60*1e3?"30 minutes":i===60*60*1e3?"hour":`${i/1e3} seconds`},handleFilterChanged:it(async function(){await this.loadEndpoints()},400),handleConfigureRateLimiting(i){this.$modal.show("UpdateRuntimeEndpointModal",{endpoint:i})},formatValue(i){return this.formatter.format(i)},formatTotalRequests(i){return i>0?this.formatter.format(i):"-"},getChartData(i){return[{title:"Requests",color:"#e0dcfd",data:i.map(o=>({label:A.fromUnix(o.timestamp).format(A.US_FRIENDLY_SHORT_DATE),value:o.hits}))}]}}},Et={class:"flex flex-column gap-16px"},Ct={key:0,class:"mb-24px"},Dt={class:"mb-16px flex align-center justify-between"},Tt={class:"flex gap-8px"},Bt={class:"flex gap-8px"},St=r("i",{class:"icon icon-information"},null,-1),Pt=r("i",{class:"icon icon-add"},null,-1),At={key:0},$t={class:"flex justify-between align-center w-full"},Lt={class:"flex align-center min-w-0"},Mt={key:0,class:"truncate flex align-center min-w-0"},qt=r("span",{class:"ml-4px mr-4px whitespace-nowrap"},"Â·",-1),Vt={class:"mr-4px truncate"},Nt={key:0},Ot={key:0},Ft={key:1},Ut={key:1,style:{"line-height":"0"}},Ht=r("img",{src:kt,alt:"GraphQL",height:"16",class:"ml-8px p-0"},null,-1),zt=[Ht],Xt={key:0},jt={class:"flex justify-between gap-16px align-center px-16px w-full"},Gt={style:{height:"50px",width:"100px"}},Qt={colspan:"6"},Wt={ref:"tableBottom"};function Yt(i,o,g,b,m,s){const d=a("RuntimeNoTokenCallout"),u=a("BaseCallout"),R=a("InputSearch"),k=a("BaseButton"),v=a("DataTableHeader"),O=a("RuntimeEndpointRowSkeleton"),y=a("BasePill"),E=a("BaseParagraph"),w=a("DataTableCell"),D=a("XTooltip"),F=a("RuntimeBarChart"),U=a("BaseIconButton"),H=a("RuntimeEndpointActions"),T=a("DataTableRow"),z=a("RuntimeEndpointsEmptyState"),X=a("DataTable");return l(),h("div",Et,[r("div",null,[t(d,{serviceId:s.serviceId},null,8,["serviceId"]),m.service&&m.service.agent&&!m.service.agent.middleware_installed?(l(),h("div",Ct,[t(u,{title:"Setup Rate limiting",description:"Add the rate limiting middleware to your code to get started.",actionLabel:"Show instructions",onAction:s.installMiddlewareClicked,variation:"warning"},null,8,["onAction"])])):f("",!0),r("div",Dt,[r("div",Tt,[t(R,{modelValue:m.search,"onUpdate:modelValue":[o[0]||(o[0]=n=>m.search=n),s.handleFilterChanged],spacing:"compact",disableDebounce:!0},null,8,["modelValue","onUpdate:modelValue"])]),r("div",Bt,[t(k,{as:"'button'",size:"small",variation:"tertiary",onClick:o[1]||(o[1]=n=>i.$modal.show("RuntimeMiddlewareInstructionsModal",{serviceId:this.serviceId}))},{default:e(()=>[St,c(" Rate Limiting Instructions ")]),_:1}),t(k,{as:"'button'",size:"small",onClick:o[2]||(o[2]=n=>i.$modal.show("AddRuntimeEndpointModal",{serviceId:this.serviceId}))},{default:e(()=>[Pt,c(" Add Route ")]),_:1})])]),t(X,null,{header:e(()=>[t(v,{width:"80px"},{default:e(()=>[c("Method")]),_:1}),t(v,{width:"auto"},{default:e(()=>[c("Route")]),_:1}),t(v,{width:"240px"},{default:e(()=>[c("Rate Limiting")]),_:1}),t(v,{width:"200px"},{default:e(()=>[c("Requests last 7 days")]),_:1}),t(v,{width:"160px"},{default:e(()=>[c("Status")]),_:1}),t(v,{width:"48px"})]),body:e(()=>[m.initialLoading?(l(),_(O,{key:0})):f("",!0),(l(!0),h(M,null,L(s.enrichedEndpoints,n=>(l(),_(T,{key:n.id,class:"text-blue-dark"},{default:e(()=>[t(w,null,{default:e(()=>[n.method==="*"?(l(),h("div",At,[t(y,{variation:"gray-fill",title:"Any"})])):(l(),_(E,{key:1},{default:e(()=>[c(p(n.method),1)]),_:2},1024))]),_:2},1024),t(w,null,{default:e(()=>[r("div",$t,[r("div",Lt,[t(E,{class:"truncate"},{default:e(()=>[r("span",null,p(n.route),1),t(D,null,{default:e(()=>[c(p(n.route),1)]),_:2},1024)]),_:2},1024),n.graphql?(l(),h("span",Mt,[qt,r("span",Vt,[c(p(n.graphql.name),1),n.graphql?(l(),_(D,{key:0},{default:e(()=>[c(p(n.graphql.name),1)]),_:2},1024)):f("",!0)]),t(y,{variation:"gray-fill",class:"text--capitalize text--semi-bold whitespace-nowrap"},{default:e(()=>[c(p(n.graphql.type),1)]),_:2},1024)])):f("",!0)]),n.allowed_ip_addresses.length>0?(l(),h("div",Nt,[t(y,{variation:"orange",class:"text--capitalize text--semi-bold text-11px--important"},{default:e(()=>[c(p(n.allowed_ip_addresses.length)+" ",1),n.allowed_ip_addresses.length===1?(l(),h("span",Ot,"IP")):(l(),h("span",Ft,"IPs")),c(" allowed")]),_:2},1024)])):f("",!0),n.graphql?(l(),h("div",Ut,zt)):f("",!0)])]),_:2},1024),t(w,null,{default:e(()=>[n.rate_limiting&&n.rate_limiting.enabled?(l(),h("div",Xt,p(n.rate_limiting.max_requests)+" requests per "+p(s.convertWindowSizeInMSToHuman(n.rate_limiting.window_size_in_ms)),1)):(l(),_(y,{key:1,class:"cursor-pointer",icon:"icon-settings",title:"Configure",variation:"gray-fill",onClick:C(B=>s.handleConfigureRateLimiting(n),["prevent"])},null,8,["onClick"]))]),_:2},1024),t(w,{spacing:"none"},{default:e(()=>[r("div",jt,[r("div",Gt,[t(F,{"chart-data":s.getChartData(n.hits.per_day),padding:{top:10},"format-value":s.formatValue},null,8,["chart-data","format-value"])]),t(E,null,{default:e(()=>[c(p(s.formatTotalRequests(n.hits.total)),1)]),_:2},1024)])]),_:2},1024),t(w,null,{default:e(()=>[n.status?(l(),_(y,{key:0,title:n.status.label,variation:n.status.color,class:"text--capitalize"},null,8,["title","variation"])):f("",!0)]),_:2},1024),t(w,{spacing:"compact",alignment:"center"},{default:e(()=>[r("div",{class:"data-table__row__action-container",onClick:o[4]||(o[4]=C(()=>{},["prevent","stop"]))},[t(H,{endpoint:n},{trigger:e(B=>[t(U,{onClick:o[3]||(o[3]=C(()=>{},["prevent","stop"])),onClicked:B.toggle,icon:"icon-actions",ref_for:!0,ref:"trigger",class:"data-table__row__action"},null,8,["onClicked"])]),_:2},1032,["endpoint"])])]),_:2},1024)]),_:2},1024))),128)),s.shouldShowEmptyState?(l(),_(T,{key:1},{default:e(()=>[r("td",Qt,[t(z,{onViewInstructions:s.viewInstructionsClicked},null,8,["onViewInstructions"])])]),_:1})):f("",!0)]),_:1}),r("div",Wt,null,512)])])}const me=x(xt,[["render",Yt]]);export{me as default};
