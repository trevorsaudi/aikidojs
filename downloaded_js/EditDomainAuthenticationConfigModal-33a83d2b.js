import{_ as U,B as E,V as L,N as F,f as I,al as D,g as T,an as M,gk as P,r as f,q as r,m as u,n as g,o as n,w as l,s as h,u as _,k as S,ai as R,S as k,p as c,F as z,t as N,M as O,H as W,gl as G,c6 as Y,gm as j,bS as q}from"./index-13ff96f4.js";import{a as m,i as B}from"./url-3f9718b2.js";import{I as J}from"./InputCheckbox-81cb3ca6.js";import{S as K}from"./ScreenshotImageCarousel-ff4bf56f.js";const Q={props:{domain:Object,authConfig:Object,isLoading:Boolean,enabledByDefault:{type:Boolean,default:!1}},components:{BaseParagraph:E,InputText:L,BaseSelect:F,BaseButton:I,LoadingSpinner:D,BaseLink:T,InputCheckbox:J,ImageCarousel:K},emits:["verificationStatus"],data(){var t,e,s,V,a,i,p,w;return{isEnabled:this.enabledByDefault,errorMessage:"",isVerifying:!1,verificationStatus:"unverified",verificationErrorMessage:null,verificationSuccessMessage:null,verificationTimeout:null,verificationSessionIdentifier:null,verificationResultScreenshots:[],data:{loginUrl:((t=this.authConfig)==null?void 0:t.login_url)??this.domain.domain_name,username:((e=this.authConfig)==null?void 0:e.credentials.username)??null,password:((s=this.authConfig)==null?void 0:s.credentials.password)??null,clientId:((V=this.authConfig)==null?void 0:V.credentials.client_id)??null,clientSecret:((a=this.authConfig)==null?void 0:a.credentials.client_secret)??null,scope:((i=this.authConfig)==null?void 0:i.credentials.scope)??"",authMethod:((p=this.authConfig)==null?void 0:p.auth_method)??"form",httpHeaders:((w=this.authConfig)==null?void 0:w.http_headers)??[{name:"",value:""}]}}},async mounted(){M.on("dast-verify-credentials",this.handleVerificationEvent),M.on("dastVerifyCredentialsScreenshotUploaded",this.handleVerificationScreenshotUploaded)},beforeUnmount(){M.off("dast-verify-credentials",this.handleVerificationEvent),M.off("dastVerifyCredentialsScreenshotUploaded",this.handleVerificationScreenshotUploaded)},watch:{authConfig(t){var e,s,V,a,i;t&&(this.isEnabled=!0,this.data.loginUrl=t.login_url,this.data.username=((e=t.credentials)==null?void 0:e.username)??null,this.data.password=((s=t.credentials)==null?void 0:s.password)??null,this.data.clientId=((V=t.credentials)==null?void 0:V.client_id)??null,this.data.clientSecret=((a=t.credentials)==null?void 0:a.client_secret)??null,this.data.scope=((i=t.credentials)==null?void 0:i.scope)??"",this.data.authMethod=t.auth_method??"form",this.data.httpHeaders=t.http_headers??[{name:"",value:""}],this.verificationStatus="verified")},"data.loginUrl"(t){var e;(this.errorMessage||this.verificationErrorMessage||this.verificationSuccessMessage)&&this.clearErrors(),((e=this.authConfig)==null?void 0:e.login_url)!==t&&(this.verificationStatus="unverified")},"data.authMethod"(t){var e;(this.errorMessage||this.verificationErrorMessage||this.verificationSuccessMessage)&&this.clearErrors(),((e=this.authConfig)==null?void 0:e.auth_method)!==t&&(this.verificationStatus="unverified"),this.hasValidBasicAuth()&&(this.verificationStatus="verified")},"data.username"(t){var e;(this.errorMessage||this.verificationErrorMessage||this.verificationSuccessMessage)&&this.clearErrors(),((e=this.authConfig)==null?void 0:e.credentials.username)!==t&&(this.verificationStatus="unverified"),this.hasValidBasicAuth()&&(this.verificationStatus="verified")},"data.password"(t){var e;(this.errorMessage||this.verificationErrorMessage||this.verificationSuccessMessage)&&this.clearErrors(),((e=this.authConfig)==null?void 0:e.credentials.password)!==t&&(this.verificationStatus="unverified"),this.hasValidBasicAuth()&&(this.verificationStatus="verified")},"data.httpHeaders":{handler(){this.hasValidHttpHeaders()?this.verificationStatus="verified":this.verificationStatus="unverified"},deep:!0},verificationStatus(t){this.$emit("verificationStatus",t)}},computed:{authMethodOptions(){return[{id:"form",title:"Login via form"},{id:"http_headers",title:"Auth via Custom Headers"},{id:"oauth_client_credentials",title:"Auth via OAuth Client Credentials"},{id:"oauth_password_grant",title:"Auth via OAuth Password Grant"},{id:"basic_auth",title:"Auth via Basic Auth"}]},sectionHeaderColor(){return this.isEnabled?"black":"subdued"},verifyButtonVariation(){return!this.isVerifying&&this.verificationStatus==="verified"?"success":!this.isVerifying&&this.verificationStatus==="failed"?"destructive":"secondary"},verifyButtonContent(){return this.verificationStatus==="verified"?"Check":this.verificationStatus==="failed"?"Failed":"Test"},verifyButtonIcon(){return this.verificationStatus==="verified"?"icon-tick-circle":this.verificationStatus==="failed"?"icon-close":"icon-secrets"},disableUrlField(){return["http_headers","basic_auth"].includes(this.data.authMethod)},disableAuthMethodSelector(){return this.domain.scan_type!=="akto"&&this.domain.scan_type!=="akto_graphql"},canRemoveHeaders(){return this.data.httpHeaders.length>1}},methods:{isFormEnabled(){return this.isEnabled},validateForm(){if(!this.isEnabled)return!0;if(this.data.authMethod==="form"){const t=m(this.data.username);t||(this.errorMessage="You must provide a username");const e=m(this.data.password);e||(this.errorMessage="A password must be provided.");const s=B(this.data.loginUrl);return s||(this.errorMessage="The provided login URL is not valid."),s&&t&&e}else{if(this.data.authMethod==="http_headers")return this.hasValidHttpHeaders()?!0:(this.errorMessage="Please make sure that the http headers have a valid name and value.",!1);if(this.data.authMethod==="oauth_client_credentials"){const t=m(this.data.username);t||(this.errorMessage="You must provide a client id");const e=m(this.data.password);e||(this.errorMessage="A client secret must be provided.");const s=B(this.data.loginUrl);return s||(this.errorMessage="The provided login URL is not valid."),s&&t&&e}else if(this.data.authMethod==="oauth_password_grant"){const t=m(this.data.username);t||(this.errorMessage="You must provide a username");const e=m(this.data.password);e||(this.errorMessage="A password must be provided.");const s=B(this.data.loginUrl);return s||(this.errorMessage="The provided login URL is not valid."),s&&t&&e}else if(this.data.authMethod==="basic_auth"){const t=m(this.data.username);t||(this.errorMessage="You must provide a username");const e=m(this.data.password);return e||(this.errorMessage="A password must be provided."),t&&e}}return!1},getFormValues(){return{domainId:this.domain.domain_id,loginUrl:this.data.loginUrl,username:this.data.username,password:this.data.password,clientId:this.data.clientId,clientSecret:this.data.clientSecret,scope:this.data.scope,authenticationMethod:this.data.authMethod,httpHeaders:this.data.httpHeaders}},async handleVerifyCredentials(){if(!(this.isVerifying||!this.validateForm())){this.clearErrors(),this.isVerifying=!0,this.verificationResultScreenshots=[];try{let e=await P(this.getFormValues());this.verificationSessionIdentifier=e.session_identifier,this.verificationTimeout=setTimeout((function(){this.verificationStatus="failed",this.isVerifying=!1,this.verificationErrorMessage="Authentication failed. We were unable to verify the credentials in time. Please try again later."}).bind(this),120*1e3)}catch{this.isVerifying=!1}}},async handleVerificationEvent(t){const{type:e,domain_id:s}=t;this.domain.domain_id==s&&(this.verificationTimeout&&clearTimeout(this.verificationTimeout),e==="completed"&&(this.clearErrors(),this.verificationStatus="verified",this.verificationSuccessMessage=this.getVerificationSucceededMessage(t.auth_session)),e==="failure"&&(this.verificationStatus="failed",this.verificationErrorMessage=this.getVerificationFailedMessage(t.message??null)),this.isVerifying=!1)},hasValidHttpHeaders(){if(this.data.authMethod!=="http_headers")return!1;for(const t of this.data.httpHeaders)if(!m(t.name)||!m(t.value))return!1;return!0},hasValidBasicAuth(){return!(this.data.authMethod!=="basic_auth"||!m(this.data.username)||!m(this.data.password))},getVerificationFailedMessage(t){return t?`Authentication failed. ${t}.`:"Authentication failed. We were unable to authenticate this user due to an unknown error."},getVerificationSucceededMessage(t){return t.type==="cookie"?`We found the following auth token '${t.redacted_token}' in cookie '${t.cookie_name}'`:`We found the following auth token '${t.redacted_token}' in http header '${t.header_name}'`},handleVerificationScreenshotUploaded(t){const{screenshot_id:e,session_identifier:s}=t;!e||this.verificationSessionIdentifier!==s||(this.verificationResultScreenshots=[...this.verificationResultScreenshots,{id:e}])},handleGetInTouch(){window.Intercom&&window.Intercom("show")},clearErrors(){this.errorMessage=null,this.verificationErrorMessage=null,this.verificationSuccessMessage=null,this.verificationStatus="unverified"},handleToggleForm(t){this.isEnabled=t},addHttpHeaderEntry(){this.data.httpHeaders.push({name:"",value:""})},removeHeader(t){const e=[...this.data.httpHeaders];e.splice(t,1),this.data.httpHeaders=e}}},X={class:"flex flex-column gap-8px"},Z=["for"],$=["name","id","value","checked"],ee={key:0,class:"flex flex-column gap-8px"},te={class:"flex"},ae={key:0,class:"flex align-center"},ie={key:1,class:"flex align-center"},se={key:2,class:"flex align-center gap-8px"},ne={class:"flex flex-column gap-8px w-full"},oe={class:"flex flex-1 w-full align-center"},re={class:"flex flex-1 w-full align-center"},le={class:"flex flex-1 w-full align-center"},de={key:3,class:"flex flex-column gap-12px"},ue=g("i",{class:"icon icon-add"},null,-1),ce={key:4,class:"flex align-center"};function he(t,e,s,V,a,i){const p=f("BaseParagraph"),w=f("LoadingSpinner"),C=f("BaseSelect"),d=f("InputText"),y=f("BaseButton"),b=f("BaseIcon"),H=f("BaseLink"),A=f("ImageCarousel");return r(),u("div",X,[g("label",{class:"cursor-pointer flex justify-between align-center rounded-8px bg-carbon-5 gap-8px px-16px py-16px",for:`enable_${s.domain.domain_name}`},[n(p,{color:i.sectionHeaderColor,"semi-bold":""},{default:l(()=>[h(_(s.domain.domain_name),1)]),_:1},8,["color"]),s.isLoading?(r(),S(w,{key:0})):(r(),u("input",{key:1,class:"cursor-pointer checkbox",name:`enable_${s.domain.domain_name}`,id:`enable_${s.domain.domain_name}`,type:"checkbox",value:a.isEnabled,checked:a.isEnabled,onInput:e[0]||(e[0]=R(o=>i.handleToggleForm(o.target.checked),["stop"]))},null,40,$))],8,Z),a.isEnabled?(r(),u("div",ee,[g("div",te,[n(C,{class:"w-50p mr-4px",options:i.authMethodOptions,modelValue:a.data.authMethod,"onUpdate:modelValue":e[1]||(e[1]=o=>a.data.authMethod=o),disabled:i.disableAuthMethodSelector},null,8,["options","modelValue","disabled"]),n(d,{class:"flex-1",modelValue:a.data.loginUrl,"onUpdate:modelValue":e[2]||(e[2]=o=>a.data.loginUrl=o),placeholder:"Login URL",name:"loginUrl",disabled:i.disableUrlField},null,8,["modelValue","disabled"])]),a.data.authMethod==="form"?(r(),u("div",ae,[n(d,{class:"w-50p mr-4px",modelValue:a.data.username,"onUpdate:modelValue":e[3]||(e[3]=o=>a.data.username=o),placeholder:"Email",name:"username"},null,8,["modelValue"]),n(d,{class:"mr-4px flex-1",modelValue:a.data.password,"onUpdate:modelValue":e[4]||(e[4]=o=>a.data.password=o),type:"password",placeholder:"Password",name:"password"},null,8,["modelValue"]),g("div",null,[n(y,{"is-loading":a.isVerifying,onClick:i.handleVerifyCredentials,variation:i.verifyButtonVariation,size:"small",class:"min-w-85px"},{default:l(()=>[i.verifyButtonIcon?(r(),u("i",{key:0,class:k(["icon icon-12px",i.verifyButtonIcon])},null,2)):c("",!0),h(" "+_(i.verifyButtonContent),1)]),_:1},8,["is-loading","onClick","variation"])])])):c("",!0),a.data.authMethod==="oauth_client_credentials"?(r(),u("div",ie,[n(d,{class:"w-50p mr-4px",modelValue:a.data.username,"onUpdate:modelValue":e[5]||(e[5]=o=>a.data.username=o),placeholder:"Client ID",name:"client_id"},null,8,["modelValue"]),n(d,{class:"mr-4px flex-1",modelValue:a.data.password,"onUpdate:modelValue":e[6]||(e[6]=o=>a.data.password=o),type:"password",placeholder:"Client Secret",name:"client_secret"},null,8,["modelValue"]),g("div",null,[n(y,{"is-loading":a.isVerifying,onClick:i.handleVerifyCredentials,variation:i.verifyButtonVariation,size:"small",class:"min-w-85px"},{default:l(()=>[i.verifyButtonIcon?(r(),u("i",{key:0,class:k(["icon icon-12px",i.verifyButtonIcon])},null,2)):c("",!0),h(" "+_(i.verifyButtonContent),1)]),_:1},8,["is-loading","onClick","variation"])])])):c("",!0),a.data.authMethod==="oauth_password_grant"?(r(),u("div",se,[g("div",ne,[g("div",oe,[n(d,{class:"w-50p mr-4px",modelValue:a.data.username,"onUpdate:modelValue":e[7]||(e[7]=o=>a.data.username=o),placeholder:"Username *",name:"username"},null,8,["modelValue"]),n(d,{class:"flex-1",modelValue:a.data.password,"onUpdate:modelValue":e[8]||(e[8]=o=>a.data.password=o),type:"password",placeholder:"Password *",name:"password"},null,8,["modelValue"])]),g("div",re,[n(d,{class:"w-50p mr-4px",modelValue:a.data.clientId,"onUpdate:modelValue":e[9]||(e[9]=o=>a.data.clientId=o),placeholder:"ClientID",name:"client_id"},null,8,["modelValue"]),n(d,{class:"mr-4px flex-1",modelValue:a.data.clientSecret,"onUpdate:modelValue":e[10]||(e[10]=o=>a.data.clientSecret=o),type:"password",placeholder:"ClientSecret",name:"client_secret"},null,8,["modelValue"]),n(y,{"is-loading":a.isVerifying,onClick:i.handleVerifyCredentials,variation:i.verifyButtonVariation,size:"small",class:"min-w-85px"},{default:l(()=>[i.verifyButtonIcon?(r(),u("i",{key:0,class:k(["icon icon-12px",i.verifyButtonIcon])},null,2)):c("",!0),h(" "+_(i.verifyButtonContent),1)]),_:1},8,["is-loading","onClick","variation"])]),g("div",le,[n(d,{class:"w-50p mr-4px",modelValue:a.data.scope,"onUpdate:modelValue":e[11]||(e[11]=o=>a.data.scope=o),placeholder:"Scope",name:"scope"},null,8,["modelValue"])])])])):c("",!0),a.data.authMethod==="http_headers"?(r(),u("div",de,[(r(!0),u(z,null,N(a.data.httpHeaders,(o,v)=>(r(),u("div",{class:"flex align-center",key:v},[n(d,{class:"w-50p mr-4px",modelValue:a.data.httpHeaders[v].name,"onUpdate:modelValue":x=>a.data.httpHeaders[v].name=x,placeholder:"Header-Name",name:`header_name_${v}`},null,8,["modelValue","onUpdate:modelValue","name"]),n(d,{class:"mr-4px flex-1",modelValue:a.data.httpHeaders[v].value,"onUpdate:modelValue":x=>a.data.httpHeaders[v].value=x,type:"password",placeholder:"Value",name:`header_value_${v}`},null,8,["modelValue","onUpdate:modelValue","name"]),i.canRemoveHeaders?(r(),S(y,{key:0,onClick:()=>i.removeHeader(v),variation:"plain-destructive-hover",size:"small",class:"min-w-20px"},{default:l(()=>[n(b,{icon:"icon-delete"})]),_:2},1032,["onClick"])):c("",!0)]))),128)),n(y,{onClick:i.addHttpHeaderEntry,variation:"plain",size:"small"},{default:l(()=>[ue,h("Add Variable ")]),_:1},8,["onClick"])])):c("",!0),a.data.authMethod==="basic_auth"?(r(),u("div",ce,[n(d,{class:"w-50p mr-4px",modelValue:a.data.username,"onUpdate:modelValue":e[12]||(e[12]=o=>a.data.username=o),placeholder:"Username",name:"username"},null,8,["modelValue"]),n(d,{class:"mr-4px flex-1",modelValue:a.data.password,"onUpdate:modelValue":e[13]||(e[13]=o=>a.data.password=o),type:"password",placeholder:"Password",name:"password"},null,8,["modelValue"])])):c("",!0),a.errorMessage?(r(),S(p,{key:5,color:"danger"},{default:l(()=>[h(_(a.errorMessage),1)]),_:1})):c("",!0),a.verificationErrorMessage?(r(),S(p,{key:6,color:"danger"},{default:l(()=>[h(_(a.verificationErrorMessage)+" ",1),n(H,{as:"button",onClick:i.handleGetInTouch},{default:l(()=>[h("Get in touch")]),_:1},8,["onClick"])]),_:1})):c("",!0),a.verificationSuccessMessage?(r(),S(p,{key:7},{default:l(()=>[h(_(a.verificationSuccessMessage),1)]),_:1})):c("",!0),n(A,{files:a.verificationResultScreenshots},null,8,["files"])])):c("",!0)])}const fe=U(Q,[["render",he]]),me={props:{domain:Array},components:{BaseModal:O,BaseParagraph:E,BaseButton:I,BaseHeading:W,DomainSectionForm:fe},emits:["close"],data(){return{isLoading:!0,isSaving:!1,authConfig:null,verificationStatus:"unverified"}},async mounted(){try{await this.getDomainAuthenticationConfig()}finally{this.isLoading=!1}},computed:{isSubmitButtonDisabled(){return this.verificationStatus!=="verified"},lastUpdatedBy(){var t;return((t=this.authConfig)==null?void 0:t.updated_by)??"unknown"}},methods:{handleCloseModal(){this.$emit("close")},async getDomainAuthenticationConfig(){try{const t=await G(this.domain.domain_id,{disable_toasts:!0});this.authConfig=t}catch(t){t instanceof Y.AxiosError&&t.response.status==403&&(this.$toast.error({title:"Unable to load information",description:"Only admins and creators are able to update and see this config"}),this.handleCloseModal())}},async handleSubmit(){if(!this.$refs.form.isFormEnabled())return this.authConfig==null&&this.return,this.$modal.show("DeleteDomainAuthenticationConfigModal",{domain:this.domain,config:this.authConfig});if(!this.$refs.form.validateForm())return;const s=this.$refs.form.getFormValues();this.isSaving=!0;try{await j(s),this.$toast.success({title:"Authentication configuration saved",description:"The authentication configuration for your domain(s) was saved successfully. We'll scan the domains again immediately."}),M.emit("domainAuthenticationConfigured"),this.handleCloseModal(),q(this.domain.domain_id,{no_disable_buttons:!0,disable_toasts:!0})}finally{this.isSaving=!1}},handleUpdateVerificationStatus(t){this.verificationStatus=t}}},pe={key:0},ge={class:"flex flex-column gap-4px"},ve={class:"flex flex-column gap-8px"};function _e(t,e,s,V,a,i){const p=f("BaseParagraph"),w=f("BaseHeading"),C=f("DomainSectionForm"),d=f("BaseButton"),y=f("BaseModal");return r(),S(y,{width:1200,onClose:i.handleCloseModal,allowBackgroundClose:!1},{header:l(()=>[n(p,{color:"gray"},{default:l(()=>{var b;return[(b=a.authConfig)!=null&&b.updated_by?(r(),u("span",pe,"Last updated by: "+_(i.lastUpdatedBy),1)):c("",!0)]}),_:1})]),content:l(()=>[n(w,{as:"h3"},{default:l(()=>[h("Enable authentication on your domain")]),_:1}),g("div",ge,[n(p,{size:"medium","semi-bold":""},{default:l(()=>[h("Select domains that need authentication")]),_:1}),n(p,null,{default:l(()=>[h("Setup form-based authentication for multiple domains")]),_:1})]),g("div",ve,[(r(),S(C,{ref:"form","enabled-by-default":!0,domain:s.domain,key:s.domain.domain_id,"auth-config":a.authConfig,"is-loading":a.isLoading,onVerificationStatus:i.handleUpdateVerificationStatus},null,8,["domain","auth-config","is-loading","onVerificationStatus"]))])]),footer:l(()=>[n(d,{variation:"plain",onClick:i.handleCloseModal,class:"ml-auto"},{default:l(()=>[h("Cancel")]),_:1},8,["onClick"]),n(d,{onClick:i.handleSubmit,"is-loading":a.isSaving,disabled:i.isSubmitButtonDisabled},{default:l(()=>[h("Confirm Authentication")]),_:1},8,["onClick","is-loading","disabled"])]),_:1},8,["onClose"])}const Me=U(me,[["render",_e]]);export{Me as default};
