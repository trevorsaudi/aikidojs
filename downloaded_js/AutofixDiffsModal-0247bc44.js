import{_ as S,d as L,h1 as w,r,q as n,m as l,n as d,k as g,w as f,u as _,s as p,o as u,p as c,U as R,h2 as W,au as z,a2 as q,al as O,h3 as X,h4 as j,h5 as G,h6 as J,an as D,h7 as H,c$ as K,F as C,t as F}from"./index-13ff96f4.js";import{X as Q,z as Y,F as Z,g as $,t as ee}from"./scmTypeIcons-6c938021.js";import{A as te}from"./ActionMenu-3e4470bf.js";import{I as ie,A as ne}from"./AIText-891d4f7b.js";import{a as se}from"./autofixSastIssues-779ec5b4.js";import{a as ae}from"./autofixable-c6560249.js";import"./InputCheckbox-81cb3ca6.js";const oe={components:{DiffView:Q,BasePill:L},props:{diffData:{type:Object,required:!0},taskId:{type:Number,required:!0}},data(){return{mode:Y.Unified,copyText:"Copy Fix"}},computed:{fileNameText(){return this.diffData.oldFile.fileName},showFakeDiff(){return this.diffData.newFile.content.length===0&&this.diffData.hunks.length===1&&this.diffData.hunks[0].length===0&&this.$user.is_aikido_support},fakeDiffContent(){return this.diffData.oldFile.content}},methods:{copyFix(){window.isSecureContext&&navigator.clipboard.writeText(this.diffData.newFile.content),this.copyText="Copied",setTimeout(()=>{this.copyText="Copy Fix"},1e3),w({task_id:this.taskId,signal:"copied"})}}},re={class:"border-1 border-carbon-20 rounded-8px"},le={class:"px-24px py-12px bg-carbon-5 rounded-t-8px flex justify-between align-center"},fe={class:"group-hover:underline"},de=d("i",{class:"ml-4px icon icon-openLink icon-12px opacity-0 group_hover_opacity-100"},null,-1),ue={key:2},ce={key:0},he=d("div",{class:"rounded-b-8px bg-carbon-5 h-6px"},null,-1);function ge(t,i,o,h,s,e){const x=r("BaseLink"),v=r("BaseParagraph"),y=r("BasePill"),m=r("DiffView");return n(),l("div",re,[d("div",le,[o.diffData.fileUrl?(n(),g(x,{key:0,href:o.diffData.fileUrl,target:"_blank",class:"text-carbon-80 inline-link text-deco-none flex align-center group"},{default:f(()=>[d("span",fe,_(e.fileNameText),1),de]),_:1},8,["href"])):(n(),g(v,{key:1,color:"dark-gray"},{default:f(()=>[p(_(e.fileNameText),1)]),_:1})),e.showFakeDiff?c("",!0):(n(),l("div",ue,[u(y,{title:s.copyText,variation:"gray-outline",class:"cursor-pointer",onClick:e.copyFix},null,8,["title","onClick"])]))]),u(m,{data:o.diffData,"diff-view-font-size":12,"diff-view-mode":s.mode,"diff-view-highlight":!0,"diff-view-add-widget":!1,"diff-view-wrap":!1,"extend-data":{oldFile:{},newFile:{}}},null,8,["data","diff-view-mode"]),e.showFakeDiff?(n(),l("div",ce,[R(d("textarea",{class:"w-full border-0","onUpdate:modelValue":i[0]||(i[0]=b=>e.fakeDiffContent=b)},null,512),[[W,e.fakeDiffContent]])])):c("",!0),he])}const me=S(oe,[["render",ge]]);function pe(t,i){return`vscode://AikidoSecurity.aikido?command=apply-autofix&task_id=${t}&repo_id=${i}`}const _e={components:{BaseConfirmModal:z,DiffSection:me,BasePill:L,XTooltip:q,ActionMenu:te,IgnoreIssueFeedbackModal:ie,FileContentViewer:Z,LoadingSpinner:O,ProgressEventItem:X,FailureEventItem:j,CompletedEventItem:G,AIText:ne},emits:["close"],props:{taskId:{type:Number,required:!0},usesVsCode:{type:Boolean,default:!1}},setup(){const{tasks:t}=J();return{autofixTasks:t}},data(){return{isConfirming:!1,copyButtonText:"Copy for validation",modalWidth:1e3,showIgnoreIssueFlow:!1,groupedIssue:null,diffs:null}},created(){D.on("autofix-llm-diffs-retrieved",this.onDiffDataUpdated)},beforeUnmount(){D.off("autofix-llm-diffs-retrieved",this.onDiffDataUpdated)},async mounted(){await this.loadDiffData(),this.calculateModalWidth()},computed:{lastAutofixEvent(){const t=this.autofixTasks.find(o=>o.task_id==this.taskId),i=(t==null?void 0:t.events)??[];return i.length==0?null:i[i.length-1]},isPreviewPending(){return this.isLoading?!0:this.diffs.diffs.some(t=>this.isPendingDiff(t))},headerDescription(){return this.isPreviewPending?"Aikido Sensei is using AI to generate this patch.":this.diffs.no_changes==!0?"Aikido Sensei could not create an Autofix for this issue.":this.diffs.confidence=="draft"?"Aikido Sensei used AI to generate this draft patch, manual work is required before merging.":"Aikido Sensei used AI to generate this patch, review carefully before merging."},confidenceTitle(){return this.diffs.confidence=="draft"?"Draft":`${this.diffs.confidence} confidence`},confidenceVariation(){return this.diffs.confidence=="zero"?"red":this.diffs.confidence=="draft"?"blue":this.diffs.confidence=="low"?"orange":this.diffs.confidence=="medium"?"blue":"green"},confidenceTooltipText(){return this.diffs.confidence=="zero"?"":this.diffs.confidence=="draft"?`Manual work is required before the fix can be applied.
Details in the description.`:this.diffs.confidence=="low"?`Aikido has tested similar fixes,
which indicate the correct approach but may be incomplete.
Further validation is necessary.`:this.diffs.confidence=="medium"?`Aikido has validated similar fixes and observed positive outcomes.
Validation is required.`:`Aikido has a robust set of benchmarks for similar fixes,
and they are proven to be effective.`},issue(){return!this.diffs||this.diffs.related_issues.length==0?null:this.diffs.related_issues[0]},showCopyButton(){return new URLSearchParams(window.location.search).get("autofix_dev")==="true"&&navigator.clipboard!==void 0},hasChanges(){return this.diffs.no_changes==!1},sections(){return[{title:"Actions",items:[{label:"Share feedback about this fix",onClick:this.openFeedBackModal,icon:"icon-message"},{hidden:!this.hasChanges,label:"Ignore issue instead of fixing",onClick:this.ignoreIssue,icon:"icon-hidden"}].filter(t=>!t.hidden)}]},issues(){if(!this.groupedIssue)return[];const t=this.diffs.related_issues.map(i=>i.id);return this.groupedIssue.issues.filter(i=>t.includes(i.id))},selectedRule(){return{target:"issue_id",value:this.issues.map(t=>t.id)}},scmTypeIcon(){return $()},canCreateAutofixPR(){return this.isPreviewPending||ae(this.issue.rule_id)?!1:this.hasChanges},buttonSubmitText(){return this.isPreviewPending?"Cancel":!this.canCreateAutofixPR&&!this.hasChanges?"Ignore Issue":this.canCreateAutofixPR?"Create PR":"Got It"},buttonSubmitIcon(){return this.isPreviewPending||!this.canCreateAutofixPR?null:this.scmTypeIcon},buttonSubmitVariation(){return this.isPreviewPending?"plain":"primary"},isLoading(){return!this.groupedIssue||!this.diffs||this.diffs.diffs.length==0}},methods:{async loadDiffData(){this.diffs=await H(this.taskId),this.diffs.diffs=this.diffs.diffs.sort((t,i)=>t.file_path.localeCompare(i.file_path)),!this.groupedIssue&&this.diffs.related_issues.length>0&&await this.loadRelatedGroupedIssue()},async onDiffDataUpdated(t){t.task_id==this.taskId&&await this.loadDiffData()},async copyDiffToClipboard(){let t=this.diffs;this.diffs||(await this.loadDiffData(),t=this.diffs),navigator.clipboard.writeText(JSON.stringify(t)).then(()=>{this.copyButtonText="Copied!"}).catch(i=>{this.copyButtonText="Failed to copy"})},getDiffData(t){var s;const i=t.file_path.split("."),o=i.length>1?i[i.length-1]:"",h=((s=this.issues.find(e=>e.file==t.file_path))==null?void 0:s.reference_url)??null;return{oldFile:{fileName:t.file_path,fileLang:o,content:t.file_content},newFile:{fileName:t.file_path,fileLang:o,content:t.file_fixed},hunks:[t.file_diff],fileUrl:h}},isPendingDiff(t){return this.hasChanges?t.file_fixed=="":!1},getFileData(t){var b;const i=t.file_path.split("."),o=i.length>1?i[i.length-1]:"",h=((b=this.issues.find(k=>k.file==t.file_path))==null?void 0:b.reference_url)??"",s=this.diffs.related_issues.find(k=>k.file==t.file_path),e=(s==null?void 0:s.start_line)??null,x=(s==null?void 0:s.end_line)??null,{content:v,contentStartLine:y}=ee(t.file_content,e,x),m=this.getNumbersBetween(e-1,x-1);return{fileName:t.file_path,fileLang:o,content:v,highlightedLineNumbers:m,contentStartLine:y,fileUrl:h}},getFileDataWithoutTrim(t){return{...this.getFileData(t),content:t.file_content,contentStartLine:1}},onSubmit(){if(this.isPreviewPending){this.onClose();return}if(!this.canCreateAutofixPR&&!this.hasChanges){this.ignoreIssue();return}if(!this.canCreateAutofixPR){this.onClose();return}this.handleStartAutoFix()},async handleStartAutoFix(){this.isConfirming=!0;try{const t=this.diffs.diffs[0].task_id;await se(this.diffs.related_issues,!1,this.groupedIssue.package_name,!1,t),w({task_id:t,signal:"pr_created"}),this.onClose()}catch{}finally{this.isConfirming=!1}},openFeedBackModal(){this.$modal.show("AutofixDiffsFeedbackModal",{diffs:this.diffs})},calculateModalWidth(){this.hasLengthyDiff()&&(this.modalWidth=1400)},hasLengthyDiff(){for(const t of this.diffs.diffs)if(this.hasLengthyContent(t.file_content)||this.hasLengthyContent(t.file_fixed))return!0;return!1},hasLengthyContent(t){const o=t.split(`
`);for(const h of o)if(h.length>=150)return!0;return!1},async openApplyFixesInVSCodeLink(){const t=this.diffs.diffs[0].task_id,i=this.diffs.related_issues[0].repo_id;w({task_id:t,signal:"ide_opened"});const o=pe(t,i);window.location.href=o},showOpenApplyFixesInVSCode(){return!(!this.usesVsCode||this.isPreviewPending||!this.canShowApplyInVSCodeForDiffs())},canShowApplyInVSCodeForDiffs(){if(!this.hasChanges||this.diffs.diffs.length>4)return!1;for(const t of this.diffs.diffs)if(this.isLargerThanOneMB(t.file_content))return!1;return!0},isLargerThanOneMB(t){return new Blob([t]).size>1024*1024},async loadRelatedGroupedIssue(){this.groupedIssue=await K(this.issue.grouped_issue_id)},ignoreIssue(){this.showIgnoreIssueFlow=!0,w({task_id:this.diffs.diffs[0].task_id,signal:"ignored"})},getNumbersBetween(t,i){if(t==i)return[t];const o=[];for(let h=t;h<=i;h++)o.push(h);return o},onClose(){D.emit("autofix_preview_modal_closed"),this.$emit("close")}}},xe={key:0,class:"-mt-16px h-160px"},be={key:1,class:"-mt-16px"},ke={class:"flex justify-between mb-24px align-top"},ve={class:"text-14px text-primary-aik-140"},ye={key:0,class:"ml-16px"},Ce={key:0,class:"flex flex-column gap-16px"},we={key:0},De={class:"flex align-center gap-8px pill__label"},Ie=d("span",null,"Generating Fix",-1),Fe={key:1,class:"flex flex-column gap-16px"},Se=d("div",{class:"flex align-center gap-8px pill__label"},[d("span",null,"No Changes")],-1),Le={key:2,class:"mt-16px"},Ae={key:0,class:"buttons modal-button-section"},Te=d("i",{class:"icon icon-caret_down icon-12px"},null,-1),Pe={key:1,class:"buttons modal-button-section"},Be={class:"flex gap-16px align-center h-40px"},Ne={key:0};function Ve(t,i,o,h,s,e){const x=r("XPreloader"),v=r("AIText"),y=r("XTooltip"),m=r("BasePill"),b=r("LoadingSpinner"),k=r("FileContentViewer"),A=r("DiffSection"),I=r("BaseButton"),T=r("ActionMenu"),P=r("ProgressEventItem"),B=r("CompletedEventItem"),N=r("FailureEventItem"),V=r("BaseLink"),E=r("BaseConfirmModal"),U=r("IgnoreIssueFeedbackModal");return n(),l(C,null,[s.showIgnoreIssueFlow?c("",!0):(n(),g(E,{key:0,width:s.modalWidth,title:"Autofix preview",allowBackgroundClose:!1,buttonSubmitText:e.buttonSubmitText,buttonSubmitIcon:e.buttonSubmitIcon,buttonSubmitVariation:e.buttonSubmitVariation,buttonSecondaryIcon:"icon-vscode",buttonSecondaryText:"Apply In VS Code",isSubmitLoading:s.isConfirming,hideSecondaryButton:!e.showOpenApplyFixesInVSCode(),onSubmit:e.onSubmit,onClose:e.onClose,onSecondaryButtonClicked:e.openApplyFixesInVSCodeLink},{bottomLeftContent:f(()=>[e.isPreviewPending?c("",!0):(n(),l("div",Ae,[u(T,{sections:e.sections,placement:"bottom-start",useBaseIcon:!0},{trigger:f(a=>[u(I,{variation:"plain",class:"inline-block text-transform-none",onClick:a.toggle},{default:f(()=>[p(" Actions "),Te]),_:2},1032,["onClick"])]),_:1},8,["sections"])])),!e.isLoading&&e.isPreviewPending&&e.lastAutofixEvent?(n(),l("div",Pe,[d("div",Be,[d("div",null,[e.lastAutofixEvent.status==="pending"?(n(),g(P,{key:0,event:e.lastAutofixEvent,messageClass:"text-12px text-carbon-60",descriptionClass:"text-10px text-carbon-60","in-progress":!0},null,8,["event"])):e.lastAutofixEvent.status==="completed"?(n(),g(B,{key:1,event:e.lastAutofixEvent,messageClass:"text-12px text-carbon-60",descriptionClass:"text-10px text-carbon-60"},null,8,["event"])):e.lastAutofixEvent.status==="failed"?(n(),g(N,{key:2,event:e.lastAutofixEvent,messageClass:"text-12px text-carbon-60",descriptionClass:"text-10px text-carbon-60"},null,8,["event"])):c("",!0)]),e.showCopyButton&&e.lastAutofixEvent.status==="failed"?(n(),l("div",Ne,[u(V,{as:"button",onClick:e.copyDiffToClipboard},{default:f(()=>[p(_(s.copyButtonText),1)]),_:1},8,["onClick"])])):c("",!0)])])):c("",!0)]),default:f(()=>[e.isLoading?(n(),l("div",xe,[u(x,{class:"absolute-centered",size:"medium"})])):(n(),l("div",be,[d("div",ke,[d("div",ve,[p(_(e.headerDescription)+" ",1),s.diffs.description?(n(),g(v,{key:0},{default:f(()=>[p(_(s.diffs.description),1)]),_:1})):c("",!0)]),e.isPreviewPending?c("",!0):(n(),l("div",ye,[u(m,{class:"text--capitalize",title:e.confidenceTitle,variation:e.confidenceVariation},{default:f(()=>[e.confidenceTooltipText?(n(),g(y,{key:0,class:"ws-pre"},{default:f(()=>[p(_(e.confidenceTooltipText),1)]),_:1})):c("",!0)]),_:1},8,["title","variation"])]))]),e.hasChanges?(n(),l("div",Ce,[(n(!0),l(C,null,F(s.diffs.diffs,(a,M)=>(n(),l(C,{key:M},[e.isPendingDiff(a)?(n(),g(k,{key:e.getFileData(a).highlightedLineNumbers.join("-"),fileName:e.getFileData(a).fileName,fileLang:e.getFileData(a).fileLang,content:e.getFileData(a).content,highlightedLineNumbers:e.getFileData(a).highlightedLineNumbers,contentStartLine:e.getFileData(a).contentStartLine,fileUrl:e.getFileData(a).fileUrl,variation:"pending"},{"content-top-right":f(()=>[!e.lastAutofixEvent||e.lastAutofixEvent.status!=="failed"?(n(),l("div",we,[u(m,{variation:"green",size:"large"},{default:f(()=>[d("div",De,[u(b,{color:"#00734b","background-color":"#DAFAF9",width:14,height:14}),Ie])]),_:1})])):c("",!0)]),_:2},1032,["fileName","fileLang","content","highlightedLineNumbers","contentStartLine","fileUrl"])):(n(),g(A,{key:1,diffData:e.getDiffData(a),taskId:o.taskId},null,8,["diffData","taskId"]))],64))),128))])):(n(),l("div",Fe,[(n(!0),l(C,null,F(s.diffs.diffs,a=>(n(),g(k,{key:e.getFileData(a).highlightedLineNumbers.join("-"),class:"max-h-400px overflow-y-auto scrollbar-simple-carbon-60--inverted",fileName:e.getFileDataWithoutTrim(a).fileName,fileLang:e.getFileDataWithoutTrim(a).fileLang,content:e.getFileDataWithoutTrim(a).content,highlightedLineNumbers:e.getFileDataWithoutTrim(a).highlightedLineNumbers,contentStartLine:e.getFileDataWithoutTrim(a).contentStartLine,fileUrl:e.getFileDataWithoutTrim(a).fileUrl},{"content-top-right":f(()=>[d("div",null,[u(m,{variation:"gray-outline"},{default:f(()=>[Se]),_:1})])]),_:2},1032,["fileName","fileLang","content","highlightedLineNumbers","contentStartLine","fileUrl"]))),128))])),e.showCopyButton?(n(),l("div",Le,[u(I,{onClick:e.copyDiffToClipboard},{default:f(()=>[p(_(s.copyButtonText),1)]),_:1},8,["onClick"])])):c("",!0)]))]),_:1},8,["width","buttonSubmitText","buttonSubmitIcon","buttonSubmitVariation","isSubmitLoading","hideSecondaryButton","onSubmit","onClose","onSecondaryButtonClicked"])),u(U,{show:s.showIgnoreIssueFlow,selectedRule:e.selectedRule,issue:e.issue,handleBulkIssues:!0,issues:e.issues,onCancel:i[0]||(i[0]=a=>s.showIgnoreIssueFlow=!1),onConfirm:e.onClose},null,8,["show","selectedRule","issue","issues","onConfirm"])],64)}const Oe=S(_e,[["render",Ve]]);export{Oe as default};
